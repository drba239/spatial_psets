(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 10.0' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[    173064,       3792]
NotebookOptionsPosition[    162856,       3620]
NotebookOutlinePosition[    163390,       3641]
CellTagsIndexPosition[    163347,       3638]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[
 RowBox[{"Quit", " "}]], "Input",
 CellChangeTimes->{3.6533946744272537`*^9},
 CellLabel->"In[27]:=",ExpressionUUID->"0ff1df98-17ce-4456-a2eb-4a7d3c9ac082"],

Cell[CellGroupData[{

Cell["Commuting, Migration and Local Employment Elasticities", "Title",
 CellChangeTimes->{{3.6177936398614283`*^9, 3.6177936406794286`*^9}, {
  3.6177959784214287`*^9, 3.6177960001944284`*^9}, {3.619346982692162*^9, 
  3.619347029408162*^9}, {3.6403459880962105`*^9, 3.6403460005534563`*^9}, {
  3.7345328908664565`*^9, 
  3.7345329041854753`*^9}},ExpressionUUID->"a6a4a3d8-695b-448b-9e0f-\
8eb7d2fb783a"],

Cell["\<\
by Ferdinando Monte, Stephen J. Redding and Esteban Rossi-Hansberg\
\>", "Subtitle",
 CellChangeTimes->{{3.7345403080987234`*^9, 3.7345403277847557`*^9}, 
   3.734540366628821*^9},ExpressionUUID->"9a9c81ac-84e8-49a4-b6d4-\
dca1a8295c2f"],

Cell[TextData[StyleBox["American Economic Review, forthcoming 2018", \
"Subsubtitle"]], "Text",
 CellChangeTimes->{{3.734540431551918*^9, 
  3.734540442041934*^9}},ExpressionUUID->"7c25d4a1-497b-4842-b1f3-\
170f6ee203cb"],

Cell[CellGroupData[{

Cell["\<\
This Mathematica notebook generates data for the counterfactual simulations  \
with Commuting Zone-level calibration.\
\>", "ItemParagraph",
 CellChangeTimes->{{3.7345404900290065`*^9, 3.7345406192092066`*^9}, {
  3.734540697827325*^9, 3.734540697827325*^9}, {3.7345408774066024`*^9, 
  3.7345408963936305`*^9}, {3.7346040423424864`*^9, 
  3.734604042892518*^9}},ExpressionUUID->"133b1d2e-1ecc-4649-af79-\
acdd54cec1cd"],

Cell["\<\
The section \[OpenCurlyDoubleQuote]Setup, Import Data\[CloseCurlyDoubleQuote] \
sets up the simulation and loads external data.\
\>", "ItemParagraph",
 CellChangeTimes->{{3.7345404900290065`*^9, 3.7345406192092066`*^9}, {
   3.7345406984473257`*^9, 3.734540718123355*^9}, 
   3.7346488154542513`*^9},ExpressionUUID->"7ce4baa3-11a2-4a71-9afb-\
d41512c541cb"],

Cell["\<\
The section \[OpenCurlyDoubleQuote]Functions\[CloseCurlyDoubleQuote] compiles \
routines to be used in the subsequent analysis.\
\>", "ItemParagraph",
 CellChangeTimes->{{3.7345404900290065`*^9, 3.7345406192092066`*^9}, {
   3.7345406984473257`*^9, 3.7345407571244164`*^9}, 
   3.734648820726198*^9},ExpressionUUID->"8f5eb156-204c-4e51-b531-\
73da46e0edb5"],

Cell["\<\
The section \[OpenCurlyDoubleQuote]Data Preparation\[CloseCurlyDoubleQuote] \
computes productivities and CZ-level trade deficits.\
\>", "ItemParagraph",
 CellChangeTimes->{{3.7345404900290065`*^9, 3.7345406192092066`*^9}, {
  3.7345406984473257`*^9, 3.7345408236415186`*^9}, {3.73454091024765*^9, 
  3.7345409235196705`*^9}},ExpressionUUID->"ee56e337-2dff-4dc2-8a81-\
7ef0fae00ed5"],

Cell["\<\
The section \[OpenCurlyDoubleQuote]Counterfactual Simulations\
\[CloseCurlyDoubleQuote] perform the exercises in the web appendix.\
\>", "ItemParagraph",
 CellChangeTimes->{{3.7345404900290065`*^9, 3.7345406192092066`*^9}, {
  3.7345406984473257`*^9, 3.734540860168574*^9}, {3.7345409344556875`*^9, 
  3.7345409353666887`*^9}},ExpressionUUID->"721fac1d-ffd8-478c-8f0e-\
22e10f18c530"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Setup, Import Data", "Chapter",
 CellChangeTimes->{{3.6403460947728767`*^9, 
  3.6403461228806877`*^9}},ExpressionUUID->"24810bc2-7e2b-4658-b33f-\
a1a69c536f30"],

Cell[CellGroupData[{

Cell["Setup", "Subsection",
 CellChangeTimes->{{3.641041048524399*^9, 
  3.6410410546884384`*^9}},ExpressionUUID->"70f29713-897c-4bca-b86a-\
15f62757f9f1"],

Cell["\<\
Setting history length to zero to avoid large memory usage during iterations\
\>", "Text",
 CellChangeTimes->{{3.6403461845928583`*^9, 3.6403461986082597`*^9}, {
  3.7345317907047844`*^9, 
  3.734531792375787*^9}},ExpressionUUID->"c6255168-3f52-40e8-b44c-\
c103c5c9250a"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"$HistoryLength", "=", "0"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetDirectory", "[", "\"\<E:\\\\CMLEE\>\"", "]"}], ";"}]}], "Input",
 CellChangeTimes->{{3.6405298131580124`*^9, 3.6405298366740127`*^9}, {
   3.640529881862013*^9, 3.6405298823650126`*^9}, {3.6527020275298114`*^9, 
   3.6527020281598125`*^9}, {3.6766421453036966`*^9, 
   3.6766421521687083`*^9}, {3.676644062306491*^9, 3.676644064396494*^9}, {
   3.6841720157647266`*^9, 3.684172042838282*^9}, {3.6845859528285155`*^9, 
   3.684585958494524*^9}, {3.73453057554792*^9, 3.734530579670926*^9}, 
   3.7345479988900337`*^9},ExpressionUUID->"7a385411-4b61-462d-8105-\
37f07536a2f1"]
}, Closed]],

Cell[CellGroupData[{

Cell["Importing CZ data", "Subsection",
 CellChangeTimes->{{3.618238947751335*^9, 3.6182389511356735`*^9}, {
  3.6183280162670417`*^9, 3.618328020314042*^9}, {3.6403463094193397`*^9, 
  3.640346316176015*^9}, {3.734531814984826*^9, 
  3.734531815064826*^9}},ExpressionUUID->"cedd2d20-4962-471b-8c44-\
a4d623cd0ad8"],

Cell["\<\
This section imports data about initial equilibrium variables at CZ level. \
\>", "Text",
 CellChangeTimes->{{3.640530396645013*^9, 3.6405304294490128`*^9}, {
  3.73453183051285*^9, 
  3.7345318448528767`*^9}},ExpressionUUID->"b9c099f3-afac-4c79-9e15-\
ba4bb89fabb9"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{"Workplace", " ", "data"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"workplaceEmp", "=", 
     RowBox[{"Flatten", "[", 
      RowBox[{
      "Import", "[", "\"\<simulation inputs\\\\cz_workplaceEmp.csv\>\"", 
       "]"}], "]"}]}], ";"}], " ", 
   RowBox[{"(*", 
    RowBox[{"number", " ", "of", " ", "jobs"}], "*)"}], " ", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"workplaceWage", "=", 
     RowBox[{"Flatten", "[", 
      RowBox[{
      "Import", "[", "\"\<simulation inputs\\\\cz_workplaceWage.csv\>\"", 
       "]"}], "]"}]}], ";"}], 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
     "average", " ", "yearly", " ", "wage", " ", "of", " ", "a", " ", "job", 
      " ", "by", " ", "workplace"}], ",", " ", "dollars"}], "*)"}], "  ", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"laborIncome", "=", 
     RowBox[{
      RowBox[{"(", 
       RowBox[{"workplaceEmp", " ", "workplaceWage"}], ")"}], "/", 
      SuperscriptBox["10", "6"]}]}], ";"}], " ", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
     "total", " ", "payment", " ", "to", " ", "workers", " ", "in", " ", "a", 
      " ", "workplace"}], ",", " ", 
     RowBox[{"in", " ", "millions"}]}], "*)"}], "  ", "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"Residence", " ", "data"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"resWage", "=", 
     RowBox[{"Flatten", "[", 
      RowBox[{
      "Import", "[", "\"\<simulation inputs\\\\cz_residentialWage.csv\>\"", 
       "]"}], "]"}]}], ";"}], 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
     "average", " ", "yearly", " ", "wage", " ", "of", " ", "a", " ", "job", 
      " ", "by", " ", "residence"}], ",", " ", "dollars"}], "*)"}], "  ", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"resEmp", "=", 
     RowBox[{"Flatten", "[", 
      RowBox[{
      "Import", "[", "\"\<simulation inputs\\\\cz_residentialEmp.csv\>\"", 
       "]"}], "]"}]}], ";"}], 
   RowBox[{"(*", 
    RowBox[{
    "number", " ", "of", " ", "residents", " ", "in", " ", "a", " ", 
     "residential", " ", "location"}], "*)"}], "  ", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"resIncome", "=", 
     RowBox[{"Flatten", "[", 
      RowBox[{
      "Import", "[", "\"\<simulation inputs\\\\cz_resIncome.csv\>\"", "]"}], 
      "]"}]}], ";"}], " ", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{"total", " ", "residential", " ", "income"}], ",", " ", 
     "millions"}], "*)"}], " ", "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"bilateral", " ", "distances"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"distancesOnlyTrading", "=", 
     RowBox[{
     "Import", "[", 
      "\"\<simulation inputs\\\\cz_distances_onlytrading.csv\>\"", "]"}]}], 
    ";"}], " ", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{
     "when", " ", "two", " ", "cz", " ", "do", " ", "not", " ", "trade"}], 
     ",", " ", 
     RowBox[{
      RowBox[{"distance", " ", "is", " ", 
       SuperscriptBox["10", "9"]}], ";", " ", 
      RowBox[{
      "a", " ", "row", " ", "is", " ", "an", " ", "origin", " ", "cz"}]}], 
     ",", " ", 
     RowBox[{
      RowBox[{"selling", " ", "to", " ", "all", " ", "destination"}], "-", 
      RowBox[{"columns", " ", "cz"}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"distancesAllPairs", "=", 
     RowBox[{
     "Import", "[", "\"\<simulation inputs\\\\cz_distances_allpairs.csv\>\"", 
      "]"}]}], ";"}], " ", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
     "distances", " ", "when", " ", "all", " ", "cz", " ", "are", " ", 
      "allowed", " ", "to", " ", "trade"}], " ", "-", " ", 
     RowBox[{"all", " ", "bilateral", " ", "distances"}]}], "*)"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
    "commuters", " ", "residing", " ", "in", " ", "a", " ", "row", " ", 
     "location", " ", "and", " ", "working", " ", "in", " ", "a", " ", 
     "column", " ", "location"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"\[Lambda]", "=", 
     RowBox[{
     "Import", "[", "\"\<simulation inputs\\\\cz_commuting_flows.csv\>\"", 
      "]"}]}], ";"}], "  ", "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"land", " ", "area"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"landArea", "=", 
     RowBox[{"Flatten", "[", 
      RowBox[{
      "Import", "[", "\"\<simulation inputs\\\\cz_land_area.csv\>\"", "]"}], 
      "]"}]}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"other", ":", " ", 
     RowBox[{
     "keeping", " ", "the", " ", "variable", " ", "names", " ", "with", " ", 
      "\"\<county\>\"", " ", "rather", " ", "than", " ", "\"\<cz_\>\"", " ", 
      "for", " ", "ease", " ", "of", " ", "comparability", " ", "across", " ",
       "codes"}]}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"countyNames", "=", 
     RowBox[{
     "Import", "[", "\"\<simulation inputs\\\\cz_names.csv\>\"", "]"}]}], 
    ";"}], "   ", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"ncounties", "=", 
     RowBox[{"Length", "[", "workplaceEmp", "]"}]}], ";"}], " ", 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
     "czDeficits", " ", "is", " ", "a", " ", "variable", " ", "created", " ", 
      "starting", " ", "from", " ", "deficits", " ", "at", " ", "county", " ", 
      RowBox[{"level", ".", " ", "This"}], " ", "instruction", " ", "has", 
      " ", "no", " ", "parallel", " ", "in", " ", "the", " ", "Mathematica", 
      " ", "file", " ", "cmlee_main", " ", "for", " ", "county"}], "-", 
     RowBox[{"level", " ", "analysis"}]}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"czDeficits", "=", 
     RowBox[{"Flatten", "[", 
      RowBox[{
      "Import", "[", "\"\<simulation inputs\\\\cz_deficits.csv\>\"", "]"}], 
      "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{"Dimensions", "[", "czDeficits", "]"}]}]}]], "Input",
 CellChangeTimes->{{3.6177881719959393`*^9, 3.6177882201907587`*^9}, 
   3.617788406342372*^9, {3.6177890158853197`*^9, 3.6177890375534863`*^9}, {
   3.6177936336394286`*^9, 3.6177936349114285`*^9}, {3.6177963289794283`*^9, 
   3.6177963358044286`*^9}, {3.617796370294429*^9, 3.6177963833694286`*^9}, {
   3.6177964197014284`*^9, 3.6177964318214283`*^9}, {3.6177966706158404`*^9, 
   3.617796676045096*^9}, 3.6177970485219574`*^9, {3.617798650890148*^9, 
   3.617798668119871*^9}, {3.6178062109435244`*^9, 3.6178062233747673`*^9}, {
   3.6178062594453745`*^9, 3.617806259892419*^9}, {3.6178213930644207`*^9, 
   3.6178213997280865`*^9}, {3.617821443194433*^9, 3.617821455244638*^9}, {
   3.6178217049844637`*^9, 3.6178217196329575`*^9}, {3.6178225093845887`*^9, 
   3.617822578820634*^9}, {3.617822728378793*^9, 3.617822748736923*^9}, {
   3.617822832852662*^9, 3.617822839825907*^9}, {3.617823328452239*^9, 
   3.6178233568600216`*^9}, {3.6178234169828067`*^9, 3.617823454423047*^9}, 
   3.617825669543646*^9, {3.6181417619428263`*^9, 3.618141762445877*^9}, {
   3.6181417986865005`*^9, 3.6181418365752892`*^9}, {3.618142544895114*^9, 
   3.6181426288385077`*^9}, {3.618652986131262*^9, 3.6186529989857445`*^9}, {
   3.6212518590014205`*^9, 3.6212518740489254`*^9}, {3.621253057387247*^9, 
   3.6212530832598343`*^9}, {3.621333830792133*^9, 3.62133385556061*^9}, {
   3.62133392397145*^9, 3.6213339403310857`*^9}, {3.6213341930753574`*^9, 
   3.621334194578508*^9}, {3.6213342481168613`*^9, 3.621334274397489*^9}, {
   3.621334419057954*^9, 3.62133444002605*^9}, {3.621334664497495*^9, 
   3.6213346901610613`*^9}, 3.6213347360746517`*^9, {3.6213355408234262`*^9, 
   3.6213356032163153`*^9}, {3.6214524607687106`*^9, 
   3.6214524609597297`*^9}, {3.621685693910078*^9, 3.621685731530078*^9}, {
   3.624214380275366*^9, 3.6242143805943975`*^9}, {3.624277186068924*^9, 
   3.6242771874610634`*^9}, {3.6277617993305416`*^9, 
   3.6277618314797564`*^9}, {3.627762089783584*^9, 3.6277621162692327`*^9}, 
   3.6277627396599817`*^9, {3.627762815194067*^9, 3.6277628154592686`*^9}, {
   3.640346465612957*^9, 3.640346467420138*^9}, {3.640455538417756*^9, 
   3.6404555414420586`*^9}, {3.6404564378993964`*^9, 3.640456450947701*^9}, {
   3.64045777969711*^9, 3.6404577854956903`*^9}, {3.640457833058446*^9, 
   3.6404578351216516`*^9}, 3.6405154090130634`*^9, {3.6405204345808125`*^9, 
   3.6405204377788124`*^9}, {3.6405273102980127`*^9, 
   3.6405273329060125`*^9}, {3.6405297551010127`*^9, 
   3.6405297715300126`*^9}, {3.640529908164013*^9, 3.640529909157013*^9}, {
   3.6405299905580125`*^9, 3.640529990881013*^9}, {3.6405303004840126`*^9, 
   3.6405303433900127`*^9}, {3.6409629264903307`*^9, 3.640962986868368*^9}, {
   3.640963030277708*^9, 3.640963038423523*^9}, {3.64103378989268*^9, 
   3.641033821806689*^9}, {3.6410346077175713`*^9, 3.6410346118368006`*^9}, {
   3.641556516773964*^9, 3.6415565373269644`*^9}, {3.6528743072904377`*^9, 
   3.6528743346814766`*^9}, {3.654261918701966*^9, 3.654261955351019*^9}, 
   3.6542620190921154`*^9, {3.684068932879491*^9, 3.684068945583517*^9}, {
   3.684069109881883*^9, 3.684069123426921*^9}, {3.684069467321076*^9, 
   3.6840694787741013`*^9}, {3.684069525987201*^9, 3.6840695553102627`*^9}, {
   3.6841710658660617`*^9, 3.6841710948951216`*^9}, {3.684171245043475*^9, 
   3.6841712486284823`*^9}, {3.6841712898605676`*^9, 
   3.6841713373236675`*^9}, {3.684171990416173*^9, 3.6841720044272013`*^9}, {
   3.684177772077518*^9, 3.6841779255178676`*^9}, {3.6846684543621483`*^9, 
   3.6846684623423834`*^9}, {3.734530910249424*^9, 3.7345309443514814`*^9}, {
   3.7345309774075336`*^9, 3.7345311081117315`*^9}},
 CellLabel->"In[3]:=",ExpressionUUID->"c9fbaa59-ba95-4802-8467-c5510e9927b5"]
}, Closed]],

Cell[CellGroupData[{

Cell["Parameters", "Subsection",
 CellChangeTimes->{{3.618239065250084*^9, 
  3.618239068690428*^9}},ExpressionUUID->"695d4f84-2f5a-4e43-927f-\
c1ff3277ca7e"],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{"\[Sigma]", "=", "4"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"\[Psi]", "=", 
    RowBox[{
     RowBox[{"-", "1.2922"}], "/", 
     RowBox[{"(", 
      RowBox[{"1", "-", "\[Sigma]"}], ")"}]}]}], ";"}], 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"this", " ", "\[Psi]", 
     RowBox[{"(", 
      RowBox[{"1", "-", "\[Sigma]"}], ")"}], " ", "comes", " ", "from", " ", 
     "the", " ", "estimated", " ", "gravity", " ", "coefficient", " ", "on", 
     " ", "CFS"}], "-", 
    RowBox[{"level", " ", "regressions"}]}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"\[Alpha]", "=", "0.6"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"\[Epsilon]", "=", "5.40129"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"\[Phi]", " ", "=", 
    RowBox[{"6.9431", "/", "\[Epsilon]"}]}], ";"}], 
  " "}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"\[Eta]zero", "=", 
   RowBox[{"Table", "[", 
    RowBox[{"0", ",", 
     RowBox[{"{", 
      RowBox[{"i", ",", "1", ",", "ncounties"}], "}"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", "\[Phi]"}], "Input",
 CellChangeTimes->{{3.6177965042380733`*^9, 3.617796510217659*^9}, {
   3.617796567282878*^9, 3.6177965674940042`*^9}, {3.617823074779013*^9, 
   3.6178230773686295`*^9}, {3.617882128995874*^9, 3.617882137887931*^9}, {
   3.6180521242935715`*^9, 3.618052124900632*^9}, {3.618056437528852*^9, 
   3.618056445591658*^9}, 3.6186529798600216`*^9, {3.621251787759297*^9, 
   3.6212518092074413`*^9}, {3.6309303834833765`*^9, 3.630930405115595*^9}, 
   3.6318759455000553`*^9, {3.6325982003655105`*^9, 3.6325982004845223`*^9}, {
   3.6326528614973965`*^9, 3.632652863049552*^9}, {3.632655634117631*^9, 
   3.6326556346936884`*^9}, {3.632835534205928*^9, 3.6328355344549522`*^9}, 
   3.6330205458614388`*^9, 3.640971214529052*^9, {3.641032926489582*^9, 
   3.6410329295004015`*^9}, {3.641033038215126*^9, 3.6410330480419917`*^9}, {
   3.6410330800557985`*^9, 3.641033092987486*^9}, {3.641118280339758*^9, 
   3.6411182878425083`*^9}, 3.6412131182516165`*^9, {3.652692646119949*^9, 
   3.6526926888620253`*^9}, {3.6526927229250946`*^9, 3.652692727194103*^9}, {
   3.6526928214092646`*^9, 3.6526928914653797`*^9}, {3.6529659895840282`*^9, 
   3.652966018157071*^9}, {3.6532119937106876`*^9, 3.6532120180617332`*^9}, {
   3.6846854228512154`*^9, 3.684685484052312*^9}, {3.73453148772431*^9, 
   3.734531507232341*^9}, {3.7345336907746716`*^9, 3.7345337061456947`*^9}},
 CellLabel->"In[52]:=",ExpressionUUID->"e0f5dc00-4131-420c-a21f-8e09ddeefc78"],

Cell[BoxData["1.2854521790164941`"], "Output",
 CellChangeTimes->{3.734533708986699*^9},
 CellLabel->"Out[58]=",ExpressionUUID->"2b3caa2a-b3fd-49a5-961b-7b1bf5e06604"]
}, Closed]]
}, Closed]],

Cell[CellGroupData[{

Cell["Fixed variable values", "Subsection",
 CellChangeTimes->{{3.641060449008478*^9, 3.64106045530832*^9}, {
  3.6410619038144484`*^9, 3.6410619040484715`*^9}, {3.6412131365384445`*^9, 
  3.6412131447792687`*^9}},ExpressionUUID->"7868d4f8-96e9-422b-b9aa-\
7048bdee3fe2"],

Cell["\<\
These variables are used in the counterfactual exercises (compiled function \
and the iteration modules), and never change across simulations.\
\>", "Text",
 CellChangeTimes->{{3.621452502457879*^9, 3.621452519735607*^9}, {
  3.621590894146161*^9, 3.621590946798161*^9}, {3.641060462638768*^9, 
  3.641060474400251*^9}, {3.6410605810613613`*^9, 3.6410605833625765`*^9}, {
  3.6410619132893953`*^9, 
  3.6410619219062567`*^9}},ExpressionUUID->"1a527d63-3448-4039-87a0-\
81310d866c5b"],

Cell["\<\
Matrix with indicators for whether a pair is a commuting possibility; the \
matrix with commuting flows (persons rather than shares) is \[Lambda]:\
\>", "Text",
 CellChangeTimes->{{3.6410605858539934`*^9, 
  3.641060591246029*^9}},ExpressionUUID->"7e20a53c-e2f3-4b10-852e-\
b032283cf2f3"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"isCommuting", "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"\[Lambda]", "[", 
         RowBox[{"[", 
          RowBox[{"i", ",", "j"}], "]"}], "]"}], "\[Equal]", "0"}], ",", "0", 
       ",", "1"}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"i", ",", "1", ",", "ncounties"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"j", ",", "1", ",", "ncounties"}], "}"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"isCommutingSp", "=", 
   RowBox[{"SparseArray", "[", "isCommuting", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"isNoCommuting", "=", 
   RowBox[{"DiagonalMatrix", "[", 
    RowBox[{"Table", "[", 
     RowBox[{"1", ",", 
      RowBox[{"{", 
       RowBox[{"i", ",", "1", ",", "ncounties"}], "}"}]}], "]"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"isNoCommutingSp", "=", 
   RowBox[{"SparseArray", "[", "isNoCommuting", "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.6212635495163555`*^9, 3.621263582227626*^9}, {
  3.6212652257629633`*^9, 3.621265252155602*^9}, {3.6213363342877297`*^9, 
  3.6213363545377045`*^9}, {3.6213367854146957`*^9, 3.6213367956386957`*^9}, {
  3.6213483716623*^9, 3.6213484134794817`*^9}, {3.6213484472008533`*^9, 
  3.621348459777111*^9}, {3.6214483181134863`*^9, 3.621448328487524*^9}, {
  3.621452418031437*^9, 3.6214524538470182`*^9}, {3.6214526411547475`*^9, 
  3.6214526422748594`*^9}, {3.6276659859585114`*^9, 3.627666079427113*^9}, {
  3.627666219117037*^9, 3.6276662195402393`*^9}},
 CellLabel->"In[22]:=",ExpressionUUID->"8f404a75-6aa5-4a94-87c6-d03c63beb496"],

Cell["Total population (number of jobs)", "Text",
 CellChangeTimes->{{3.621452673706002*^9, 3.6214527011307445`*^9}, 
   3.6215909326641607`*^9, 3.6410605957312584`*^9, 
   3.734532012175129*^9},ExpressionUUID->"51ceffeb-e4e7-4e18-b028-\
92b5ec96fc9a"],

Cell[BoxData[
 RowBox[{
  RowBox[{"population", "=", 
   RowBox[{"Total", "[", "workplaceEmp", "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.641060575538524*^9, 3.6410605760397277`*^9}},
 CellLabel->"In[26]:=",ExpressionUUID->"03ec0c26-be9b-4fe7-b547-108ec29cda6f"]
}, Closed]]
}, Closed]],

Cell[CellGroupData[{

Cell["Functions", "Chapter",
 CellChangeTimes->{{3.6409717280634003`*^9, 3.640971740310625*^9}, 
   3.6412131541002007`*^9},ExpressionUUID->"5db54d4c-dfcd-4e71-9ce5-\
9d4d60c7891a"],

Cell[CellGroupData[{

Cell["Productivity Estimates", "Subchapter",
 CellChangeTimes->{{3.640973160356666*^9, 
  3.640973165221845*^9}},ExpressionUUID->"aa5f7054-d3d2-4231-a4e0-\
e28a31bcc494"],

Cell["\<\
Compiled function to compute new guess of labor income on a local labor \
market (this is the RHS of the iteration below, productivities)\
\>", "Text",
 CellChangeTimes->{{3.618142258895517*^9, 3.6181422795275803`*^9}, {
  3.6410390493407545`*^9, 3.6410390641904793`*^9}, {3.6410393834702835`*^9, 
  3.641039387348895*^9}},ExpressionUUID->"7351d689-447d-452b-b811-\
c2dd2ae9361b"],

Cell[BoxData[
 RowBox[{
  RowBox[{"rhsProductivities", "=", 
   RowBox[{"Compile", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"prod", ",", "_Real", ",", "1"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"num", ",", "_Real", ",", "2"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"expenditure", ",", "_Real", ",", "1"}], "}"}]}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "bilatRes", ",", "multResistance", ",", "effDemand", ",", "leh"}], 
        "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"bilatRes", "=", 
         RowBox[{"num", " ", "prod"}]}], ";", 
        RowBox[{"(*", 
         RowBox[{"proportional", " ", "to", " ", "bilateral", " ", "cost"}], 
         "*)"}], "\[IndentingNewLine]", 
        RowBox[{"multResistance", "=", 
         RowBox[{"Total", "[", "bilatRes", "]"}]}], ";", " ", 
        RowBox[{"(*", 
         RowBox[{"denominator", " ", "in", " ", "RHS"}], "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{"effDemand", "=", 
         RowBox[{"expenditure", "/", "multResistance"}]}], ";", " ", 
        RowBox[{"(*", 
         RowBox[{
          RowBox[{"income", "/", "denominator"}], " ", "in", " ", "RHS"}], 
         "*)"}], "\[IndentingNewLine]", 
        RowBox[{"leh", "=", " ", 
         RowBox[{"bilatRes", ".", "effDemand"}]}], ";", " ", 
        "\[IndentingNewLine]", "leh"}]}], "\[IndentingNewLine]", "]"}]}], 
    RowBox[{"(*", 
     RowBox[{
     "RHS", " ", "with", " ", "current", " ", "guess", " ", "of", " ", 
      "productivity"}], "*)"}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.618142004332063*^9, 3.618142006277258*^9}, {
   3.618250294262586*^9, 3.6182503233884983`*^9}, {3.6410315196409187`*^9, 
   3.641031520135968*^9}, 3.6410316953664894`*^9, {3.641034468265854*^9, 
   3.6410344726586943`*^9}, {3.641034529403062*^9, 3.641034529574663*^9}, {
   3.641039019031889*^9, 3.6410390223848786`*^9}, {3.6411180171654434`*^9, 
   3.641118018324559*^9}, {3.641118186097335*^9, 3.6411181909478197`*^9}, {
   3.641118377182441*^9, 3.6411183778385067`*^9}, {3.6411184458333054`*^9, 
   3.6411184472344456`*^9}, {3.641120121127818*^9, 3.64112012144785*^9}, {
   3.6841789517932243`*^9, 3.6841789635542517`*^9}, 3.684586053493699*^9},
 CellLabel->"In[35]:=",ExpressionUUID->"d6eddaf4-37ee-4f20-864d-8d5968332cb2"],

Cell["\<\
Loop to compute productivities. This function receives 1) workplace \
employment (in persons), 2) workplace wage per person (in dollars), 3) total \
residential expenditure (in millions) and 4) a bilateral distance matrix (all \
pairs, or only cz trading in the cfs data); residential expenditure allows \
for deficits.
It returns productivity levels that exactly rationalize the data on workplace \
income and residential expenditure. It uses the rhsProductivities function \
above to compute new rhs during the iterations.\
\>", "Text",
 CellChangeTimes->{{3.6181422854471717`*^9, 3.618142313167944*^9}, {
   3.641033853222706*^9, 3.641034030436455*^9}, {3.6410347598315625`*^9, 
   3.6410348324045706`*^9}, {3.64103932700793*^9, 3.641039373392291*^9}, 
   3.641060252495369*^9, {3.64112594862951*^9, 3.6411260990405498`*^9}, {
   3.6411261930769525`*^9, 3.64112624966261*^9}, {3.641126433202963*^9, 
   3.6411264689075327`*^9}, {3.7345321425853252`*^9, 
   3.7345321488823347`*^9}, {3.7345322160924377`*^9, 3.734532228840457*^9}, {
   3.734534434313802*^9, 
   3.7345344343438015`*^9}},ExpressionUUID->"75a9bef1-f92d-4f80-8761-\
ca6501421c21"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"productivities", "[", 
    RowBox[{
    "workemp_", ",", "workwage_", ",", "resExp_", ",", "distmatrix_", ",", 
     "detailsYN_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "A0", ",", "\[Lambda]", ",", "tol", ",", "c", ",", "dist", ",", 
       "distmin", ",", "gap", ",", "labIncomeHat", ",", "A1", ",", "den", ",",
        "numerators", ",", "labIncome"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"\[Lambda]", "=", "0.7"}], ";", " ", 
      RowBox[{"(*", 
       RowBox[{"step", " ", "size"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"A0", "=", 
       RowBox[{"Table", "[", 
        RowBox[{"1.", ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "ncounties"}], "}"}]}], "]"}]}], ";", 
      " ", 
      RowBox[{"(*", 
       RowBox[{
       "initial", " ", "condition", " ", "for", " ", "productivities"}], 
       "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"tol", "=", 
       SuperscriptBox["10", 
        RowBox[{"-", "6"}]]}], ";", " ", 
      RowBox[{"(*", 
       RowBox[{"tolerance", " ", "level"}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"c", "=", "0"}], ";", "\[IndentingNewLine]", 
      RowBox[{"dist", "=", "1"}], ";", "\[IndentingNewLine]", 
      RowBox[{"numerators", "=", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{"workemp", " ", 
          SuperscriptBox[
           RowBox[{"(", 
            FractionBox["workwage", 
             SuperscriptBox["10", "4"]], ")"}], 
           RowBox[{"1", "-", "\[Sigma]"}]]}], " ", ")"}], " ", 
        SuperscriptBox[
         RowBox[{"(", "distmatrix", ")"}], 
         RowBox[{"\[Psi]", 
          RowBox[{"(", 
           RowBox[{"1", "-", "\[Sigma]"}], ")"}]}]]}]}], ";", " ", 
      "\[IndentingNewLine]", 
      RowBox[{"labIncome", "=", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{"workemp", " ", "workwage"}], ")"}], "/", 
        SuperscriptBox["10", "6"]}]}], ";", " ", 
      RowBox[{"(*", 
       RowBox[{
       "left", " ", "hand", " ", "side", " ", "of", " ", "trade", " ", 
        "flows", " ", "equation"}], "*)"}], "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{
         RowBox[{
         "Note", " ", "that", " ", "the", " ", "iterations", " ", "solve", 
          " ", "for", " ", 
          SuperscriptBox["A", 
           RowBox[{"\[Sigma]", "-", "1"}]]}], ";", " ", 
         RowBox[{"before", " ", "returning", " ", "the", " ", "output"}]}], 
        ",", " ", 
        RowBox[{
        "these", " ", "guesses", " ", "are", " ", "rescaled", " ", "to", " ", 
         "the", " ", 
         RowBox[{"1", "/", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{"\[Sigma]", "-", "1"}], ")"}], "."}]}]}]}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"While", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"dist", ">", "tol"}], " ", "&&", "  ", 
         RowBox[{"c", "<", "10000"}]}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"c", "=", 
          RowBox[{"c", "+", "1"}]}], ";", "\[IndentingNewLine]", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{"New", " ", "labor", " ", "Expenditure"}], "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"labIncomeHat", "=", 
          RowBox[{"rhsProductivities", "[", 
           RowBox[{"A0", ",", "numerators", ",", "resExp"}], "]"}]}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         " ", 
         RowBox[{"(*", 
          RowBox[{
          "Relative", " ", "gap", " ", "in", " ", "labor", " ", 
           "expenditure"}], "*)"}], "\[IndentingNewLine]", 
         RowBox[{"gap", "=", 
          RowBox[{"labIncome", " ", "/", "labIncomeHat"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"dist", "=", 
          RowBox[{"Max", "[", 
           RowBox[{"Abs", "[", 
            RowBox[{"gap", "-", "1"}], "]"}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"distmin", "=", 
          RowBox[{"Min", "[", 
           RowBox[{"Abs", "[", 
            RowBox[{"gap", "-", "1"}], "]"}], "]"}]}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", " ", 
         RowBox[{"(*", 
          RowBox[{"new", " ", "guess", " ", "of", " ", "productivity"}], 
          "*)"}], "\[IndentingNewLine]", 
         RowBox[{"A1", "=", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{"\[Lambda]", " ", "+", " ", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"1", "-", "\[Lambda]"}], ")"}], "gap"}]}], ")"}], 
           "A0"}]}], ";", " ", "\[IndentingNewLine]", 
         RowBox[{"den", "=", 
          RowBox[{"Mean", "[", "A1", "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"A0", "=", 
          RowBox[{"A1", "/", "den"}]}], ";", "\[IndentingNewLine]", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", "diagnostics", "*)"}], "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"Mod", "[", 
              RowBox[{"c", ",", "50"}], "]"}], "\[Equal]", "1"}], "  ", "&&", 
            " ", 
            RowBox[{"dist", ">", "0.01"}], " ", "&&", " ", 
            RowBox[{"detailsYN", "\[Equal]", "1"}]}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"Block", "[", 
             RowBox[{
              RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"Print", "[", 
                RowBox[{"\"\<end of iteration \>\"", ",", "c", ",", " ", 
                 RowBox[{"\"\< at \>\"", " ", 
                  RowBox[{"DateString", "[", "]"}]}], ",", " ", 
                 "\"\<; min gap: \>\"", ",", " ", "distmin", ",", 
                 "\"\<; max gap: \>\"", ",", "dist", ",", " ", " ", 
                 "\"\< - \>\"", ",", 
                 RowBox[{"Min", "[", "A0", "]"}], ",", "\"\< \>\"", ",", 
                 RowBox[{"Max", "[", "A0", "]"}]}], "]"}], ";"}]}], 
             "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", 
          "]"}], ";"}]}], "\[IndentingNewLine]", "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"detailsYN", "\[Equal]", "1"}], ",", 
        RowBox[{"Block", "[", 
         RowBox[{
          RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"Print", "[", 
            RowBox[{"\"\<end of iteration \>\"", ",", "c", ",", " ", 
             RowBox[{"\"\< at \>\"", " ", 
              RowBox[{"DateString", "[", "]"}]}], ",", " ", 
             "\"\<; max gap: \>\"", ",", "dist", ",", " ", "\"\< \>\"", ",", 
             RowBox[{"Min", "[", "A0", "]"}], ",", "\"\< \>\"", ",", 
             RowBox[{"Max", "[", "A0", "]"}]}], "]"}], ";"}]}], 
         "\[IndentingNewLine]", "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"A0", "=", 
       FractionBox[
        SuperscriptBox["A0", 
         RowBox[{"1", "/", 
          RowBox[{"(", 
           RowBox[{"\[Sigma]", "-", "1"}], ")"}]}]], 
        RowBox[{"Mean", "[", 
         SuperscriptBox["A0", 
          RowBox[{"1", "/", 
           RowBox[{"(", 
            RowBox[{"\[Sigma]", "-", "1"}], ")"}]}]], "]"}]]}], ";", " ", 
      RowBox[{"(*", 
       RowBox[{
       "Recovering", " ", "productivities", " ", "from", " ", "the", " ", 
        SuperscriptBox["A", 
         RowBox[{"\[Sigma]", "-", "1"}]], " ", "values", " ", "that", " ", 
        "fit", " ", "the", " ", "data"}], "*)"}], "\[IndentingNewLine]", 
      "A0"}]}], "\[IndentingNewLine]", "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.618142336775304*^9, 3.6181424881154366`*^9}, {
   3.6181426477794013`*^9, 3.6181426807416973`*^9}, {3.6181428462412453`*^9, 
   3.6181428563582573`*^9}, {3.618154248205328*^9, 3.618154267010208*^9}, {
   3.6182206246216536`*^9, 3.6182207209092817`*^9}, 3.6182211853317194`*^9, {
   3.618250337424902*^9, 3.618250351161276*^9}, {3.6410315230022545`*^9, 
   3.64103155255621*^9}, {3.6410316992638793`*^9, 3.641031703048258*^9}, {
   3.6410322686234736`*^9, 3.641032309691945*^9}, {3.6410324042304564`*^9, 
   3.641032488591636*^9}, {3.6410325251426926`*^9, 3.6410325303721275`*^9}, {
   3.641032587413123*^9, 3.6410326219435616`*^9}, {3.641033125720109*^9, 
   3.64103312742052*^9}, {3.6410340524449987`*^9, 3.641034070494314*^9}, {
   3.641034192502945*^9, 3.6410341938450785`*^9}, {3.641034233930087*^9, 
   3.6410342951382074`*^9}, {3.641034366843377*^9, 3.641034381187811*^9}, {
   3.6410344210461473`*^9, 3.6410344301566057`*^9}, {3.6410346367555623`*^9, 
   3.6410347113678474`*^9}, {3.6410348561529236`*^9, 
   3.6410348621347623`*^9}, {3.641037741529352*^9, 3.6410377561046486`*^9}, 
   3.6410390287165704`*^9, {3.64103939700593*^9, 3.641039424383628*^9}, {
   3.641118741733893*^9, 3.641118743076027*^9}, 3.641118865232241*^9, {
   3.641120695572257*^9, 3.641120754888188*^9}, {3.6411208074184403`*^9, 
   3.6411208083775363`*^9}, {3.6411242478624506`*^9, 3.641124330477711*^9}, {
   3.6411253316758213`*^9, 3.641125332745928*^9}, {3.68417897090427*^9, 
   3.6841789715142713`*^9}, {3.6841790425939417`*^9, 
   3.6841790530189667`*^9}, {3.684179096416562*^9, 3.6841791003215704`*^9}, {
   3.6845860771817403`*^9, 3.6845860788727427`*^9}},
 CellLabel->"In[36]:=",ExpressionUUID->"a26ba2f3-d1d4-4feb-8909-fd2982898e02"]
}, Closed]],

Cell[CellGroupData[{

Cell["Trade", "Subchapter",
 CellChangeTimes->{{3.6409732004973907`*^9, 
  3.6409732011864243`*^9}},ExpressionUUID->"d6017916-8671-4779-a066-\
809cdd3e3d48"],

Cell["\<\
Function to compute trade flows and trade shares given productivities, \
workplace employment and wage, residential expenditure, distance matrix.
The function returns 1) a matrix of trade shares - for each row origin, the \
shares of expenditure of each destination' s income on it, and 2) the \
corresponding trade flow values in millions of dollars.\
\>", "Text",
 CellChangeTimes->{{3.6409732104134884`*^9, 3.64097322129723*^9}, {
  3.641040608807227*^9, 3.641040634757822*^9}, {3.64104137389859*^9, 
  3.64104138161104*^9}},ExpressionUUID->"4f17a335-fedf-4f0b-aa2e-\
0980db569b11"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"trade", "=", 
    RowBox[{"Compile", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"prod", ",", "_Real", ",", "1"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"workemp", ",", "_Real", ",", "1"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"workwage", ",", "_Real", ",", "1"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"expenditure", ",", "_Real", ",", "1"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"distmatrix", ",", "_Real", ",", "2"}], "}"}]}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"Module", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "num", ",", "bilatRes", ",", "multResistance", ",", "share", ",", 
          "trade"}], "}"}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"num", "=", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{"workemp", " ", 
             SuperscriptBox[
              RowBox[{"(", 
               FractionBox["workwage", 
                SuperscriptBox["10", "4"]], ")"}], 
              RowBox[{"1", "-", "\[Sigma]"}]]}], " ", ")"}], " ", 
           SuperscriptBox[
            RowBox[{"(", "distmatrix", ")"}], 
            RowBox[{"\[Psi]", 
             RowBox[{"(", 
              RowBox[{"1", "-", "\[Sigma]"}], ")"}]}]]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"bilatRes", "=", 
          RowBox[{"num", " ", 
           SuperscriptBox["prod", 
            RowBox[{"\[Sigma]", "-", "1"}]]}]}], ";", 
         RowBox[{"(*", 
          RowBox[{"proportional", " ", "to", " ", "bilateral", " ", "cost"}], 
          "*)"}], "\[IndentingNewLine]", 
         RowBox[{"multResistance", "=", 
          RowBox[{"Total", "[", "bilatRes", "]"}]}], ";", " ", 
         RowBox[{"(*", 
          RowBox[{"denominator", " ", "in", " ", "RHS"}], "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"share", "=", 
          RowBox[{"Transpose", "[", 
           FractionBox[
            RowBox[{"Transpose", "[", "bilatRes", "]"}], "multResistance"], 
           " ", "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"trade", "=", 
          RowBox[{"Transpose", "[", 
           RowBox[{
            RowBox[{"Transpose", "[", "share", "]"}], " ", "expenditure"}], 
           "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"share", ",", "trade"}], "}"}]}]}], "\[IndentingNewLine]", 
       "]"}]}], 
     RowBox[{"(*", 
      RowBox[{
      "RHS", " ", "with", " ", "current", " ", "guess", " ", "of", " ", 
       "productivity"}], "*)"}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}]], "Input",
 CellChangeTimes->{{3.6181553097994766`*^9, 3.6181553385203485`*^9}, {
   3.6181554722897243`*^9, 3.618155487220217*^9}, {3.618155532581753*^9, 
   3.618155671880681*^9}, {3.618157001145419*^9, 3.61815702661714*^9}, {
   3.618157183395522*^9, 3.6181571890689793`*^9}, 3.618157241512991*^9, {
   3.6181572889330244`*^9, 3.6181572953338995`*^9}, {3.6181576101301303`*^9, 
   3.6181576438540244`*^9}, {3.618157697029706*^9, 3.618157716079801*^9}, {
   3.6182216321223936`*^9, 3.6182216351016912`*^9}, {3.618252070296172*^9, 
   3.6182520903991823`*^9}, {3.641039523381257*^9, 3.641039523693249*^9}, {
   3.6410396097864475`*^9, 3.641039629011155*^9}, {3.641039673229224*^9, 
   3.641039678503889*^9}, {3.6410397756961565`*^9, 3.641039909415701*^9}, 
   3.641040639999346*^9},
 CellLabel->"In[37]:=",ExpressionUUID->"a538e1d1-1578-4fb4-8cba-c1e53f66e8d5"]
}, Closed]],

Cell[CellGroupData[{

Cell["Counterfactual simulations", "Subchapter",
 CellChangeTimes->{{3.6214514924818916`*^9, 3.6214514946341066`*^9}, {
  3.621452590616694*^9, 3.621452594969129*^9}, {3.632855077025638*^9, 
  3.63285511874781*^9}, {3.6410601618069654`*^9, 3.64106017019322*^9}, {
  3.6412089705088835`*^9, 
  3.64120897057289*^9}},ExpressionUUID->"a94b2b28-96d8-4b5a-b49f-\
e83b1333db81"],

Cell[CellGroupData[{

Cell["Changes in any parameter", "Section",
 CellChangeTimes->{{3.6410601939463835`*^9, 3.641060196729202*^9}, 
   3.641061951546221*^9, {3.641139790902745*^9, 
   3.641139797142369*^9}},ExpressionUUID->"80869ab6-d2ad-452e-951a-\
aaf3e4c23dd2"],

Cell[CellGroupData[{

Cell["Guess Update", "Subsubsection",
 CellChangeTimes->{{3.623577682322913*^9, 3.6235776952636943`*^9}, {
  3.633199154099571*^9, 3.6331992064278035`*^9}, {3.641060312731363*^9, 
  3.6410603148841767`*^9}, {3.64106062441985*^9, 
  3.6410606378003407`*^9}},ExpressionUUID->"5a2a130a-9d05-4c00-8968-\
b5bfeafdf82a"],

Cell["\<\
This compiled function appears in iterations: it takes as input a current \
what and \[Lambda]hat proposals - given trade and commuting costs - and gives \
back new proposals.\
\>", "Text",
 CellChangeTimes->{{3.6214514983494787`*^9, 3.621451511561799*^9}, {
  3.621451563611004*^9, 
  3.621451629013543*^9}},ExpressionUUID->"c807d43c-0e40-4d26-8f97-\
fc04db24a702"],

Cell[BoxData[
 RowBox[{
  RowBox[{"allChangesGuess", "=", 
   RowBox[{"Compile", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"inWhat", ",", "_Real", ",", "1"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"in\[Lambda]", ",", "_Real", ",", "2"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"khat", ",", "_Real", ",", "2"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"dhat", ",", "_Real", ",", "2"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"ahat", ",", "_Real", ",", "1"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"bhat", ",", "_Real", ",", "2"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"\[Chi]", ",", "_Real", ",", "1"}], "}"}]}], "}"}], ",", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"allChangesGuessMod", "=", 
      RowBox[{"Module", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "iterVbar", ",", "iterLM", ",", "iterLR", ",", "iterQ", ",", 
          "iter\[Pi]ni", ",", "iterP", ",", "iter\[Lambda]tilde", ",", 
          "iterWtilde", ",", "distWages", ",", "dist\[Lambda]", ",", "wout", 
          ",", "\[Lambda]out", ",", "diag", ",", "\[IndentingNewLine]", 
          "temp1", ",", "temp2", ",", "temp3", ",", "temp4", ",", "temp5", 
          ",", "temp6", ",", "denRes", ",", "numRes", ",", "den", ",", "num", 
          ",", "den2", ",", "temp7", ",", "temp8", ",", "outcome"}], "}"}], 
        ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{"vbar", " ", "hat"}], "*)"}], "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"temp1", "=", "  ", 
          FractionBox[
           RowBox[{"\[Lambda]", " ", "bhat"}], 
           SuperscriptBox["khat", "\[Epsilon]"]]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"denRes", "=", 
          RowBox[{"temp1", ".", 
           SuperscriptBox["inWhat", "\[Epsilon]"]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"numRes", "=", 
          RowBox[{"temp1", ".", 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["inWhat", 
              RowBox[{"\[Epsilon]", "+", "1"}]], " ", "workplaceWage"}], 
            ")"}]}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"iterVbar", "=", 
          FractionBox["numRes", 
           RowBox[{"resWage", " ", "denRes"}]]}], ";", "\[IndentingNewLine]", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{"lm", " ", "hat", " ", "and", " ", "lr", " ", "hat"}], 
          "*)"}], "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
           RowBox[{"note", ":", " ", 
            RowBox[{"\[Lambda]", " ", "are", " ", "already", " ", "flows"}]}],
            ",", " ", 
           RowBox[{
            RowBox[{"i", ".", "e", ".", " ", "shares"}], " ", "times", " ", 
            "Lbar", " ", "in", " ", "the", " ", "equations"}]}], "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"temp1", "=", 
          RowBox[{"\[Lambda]", " ", "in\[Lambda]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"iterLM", "=", 
          FractionBox[
           RowBox[{"Total", "[", "temp1", "]"}], "workplaceEmp"]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"iterLR", "=", 
          FractionBox[
           RowBox[{"Total", "[", 
            RowBox[{"Transpose", "[", "temp1", "]"}], "]"}], "resEmp"]}], ";",
          "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{"q", " ", "hat"}], "*)"}], "\[IndentingNewLine]", 
         "\[IndentingNewLine]", 
         RowBox[{"iterQ", "=", 
          SuperscriptBox[
           RowBox[{"(", 
            FractionBox[
             RowBox[{
              RowBox[{"resIncome", " ", "iterVbar", " ", "iterLR"}], "+", 
              "deficit"}], 
             RowBox[{"resIncome", "+", "deficit"}]], " ", ")"}], 
           RowBox[{"1", "/", 
            RowBox[{"(", 
             RowBox[{"1", "+", "\[Chi]"}], ")"}]}]]}], ";", "  ", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{"\[Pi]ni", " ", "hat"}], "*)"}], "\[IndentingNewLine]", 
         RowBox[{"temp1", "=", 
          RowBox[{"\[Pi]niOnlyTrading", " ", 
           SuperscriptBox["dhat", 
            RowBox[{"(", 
             RowBox[{"1", "-", "\[Sigma]"}], ")"}]]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"temp2", "=", 
          RowBox[{"iterLM", " ", 
           SuperscriptBox[
            RowBox[{"(", 
             FractionBox["inWhat", "ahat"], ")"}], 
            RowBox[{"1", "-", "\[Sigma]"}]]}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"den", "=", 
          RowBox[{"temp2", ".", "temp1"}]}], ";", " ", 
         RowBox[{"(*", 
          RowBox[{
           RowBox[{"note", " ", "that", " ", "left"}], "-", 
           RowBox[{
           "product", " ", "effectively", " ", "gives", " ", "the", " ", 
            "transpose", " ", "of", " ", "temp1", " ", "times", " ", 
            RowBox[{"temp2", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
         RowBox[{"num", "=", 
          RowBox[{
           SuperscriptBox["dhat", 
            RowBox[{"(", 
             RowBox[{"1", "-", "\[Sigma]"}], ")"}]], " ", "temp2"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"iter\[Pi]ni", "=", 
          RowBox[{"Transpose", "[", 
           FractionBox[
            RowBox[{"Transpose", "[", "num", "]"}], "den"], "  ", "]"}]}], 
         " ", ";", 
         RowBox[{"(*", 
          RowBox[{
           RowBox[{
           "the", " ", "term", " ", "inside", " ", "divides", " ", "each", 
            " ", "column", " ", "by", " ", "the", " ", "correspondent", " ", 
            "element", " ", "of", " ", "the", " ", "denominator"}], ";", " ", 
           RowBox[{
           "it", " ", "then", " ", "brings", " ", "the", " ", "matrix", " ", 
            "in", " ", "the", " ", "original", " ", "form"}]}], "*)"}], 
         "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{"P", " ", "hat"}], "*)"}], "\[IndentingNewLine]", 
         RowBox[{"diag", "=", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{"iter\[Pi]ni", "[", 
             RowBox[{"[", 
              RowBox[{"i", ",", "i"}], "]"}], "]"}], ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", "1", ",", "ncounties"}], "}"}]}], "]"}]}], ";",
          "\[IndentingNewLine]", 
         RowBox[{"iterP", "=", 
          RowBox[{
           FractionBox["inWhat", "ahat"], 
           SuperscriptBox[
            RowBox[{"(", 
             FractionBox["iterLM", "diag"], ")"}], 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"1", "-", "\[Sigma]"}], ")"}]}]]}]}], "  ", ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
           RowBox[{"w", " ", "hat"}], ",", " ", 
           RowBox[{"next", " ", "iteration"}]}], "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"temp1", "=", 
          RowBox[{"\[Pi]niOnlyTrading", " ", "iter\[Pi]ni"}]}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"temp4", "=", 
          RowBox[{
           RowBox[{"iterVbar", " ", "iterLR", "  ", "resIncome"}], "+", 
           "deficit"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"iterWtilde", "=", 
          FractionBox[
           RowBox[{"temp1", ".", "temp4"}], 
           RowBox[{"laborIncome", " ", "iterLM"}]]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"iterWtilde", "=", 
          FractionBox["iterWtilde", 
           RowBox[{"Mean", "[", "iterWtilde", "]"}]]}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
           RowBox[{"\[Lambda]", " ", "hat"}], ",", " ", 
           RowBox[{"next", " ", "iteration"}]}], "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"temp7", "=", 
          RowBox[{
           SuperscriptBox["iterP", 
            RowBox[{"-", "\[Alpha]"}]], " ", 
           SuperscriptBox["iterQ", 
            RowBox[{
             RowBox[{"-", "1"}], "+", "\[Alpha]"}]]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"temp6", "=", 
          RowBox[{"bhat", " ", 
           FractionBox[
            SuperscriptBox[
             RowBox[{"(", 
              RowBox[{"Outer", "[", 
               RowBox[{"Times", ",", "temp7", ",", "inWhat"}], "]"}], ")"}], 
             "\[Epsilon]"], 
            SuperscriptBox["khat", "\[Epsilon]"]]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"den2", "=", 
          RowBox[{"Total", "[", 
           RowBox[{"Total", "[", 
            RowBox[{"\[Lambda]", " ", "temp6"}], "]"}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"iter\[Lambda]tilde", "=", 
          FractionBox[
           RowBox[{"(", 
            RowBox[{"temp6", " ", "population"}], ")"}], "den2"]}], " ", ";", 
         " ", 
         RowBox[{"(*", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{
             "to", " ", "limit", " ", "accumulation", " ", "of", " ", 
              "numerical", " ", "errors"}], " ", "-", " ", 
             RowBox[{
             "unconditional", " ", "shares", " ", "of", " ", "commuting", " ",
               "\[IndentingNewLine]", "have", " ", "a", " ", "very", " ", 
              "small", " ", "order", " ", "of", " ", "magnitude"}], " ", "-", 
             " ", 
             RowBox[{
             "we", " ", "predict", " ", "new", " ", "commuting", " ", "flows",
               " ", "in", " ", "#", " ", "of", " ", "jobs"}]}], ";", " ", 
            "hence"}], ",", " ", 
           RowBox[{
            RowBox[{
            "the", " ", "numerator", " ", "is", " ", "multiplied", " ", "by", 
             " ", "the", " ", "population", " ", "level", " ", "before", " ", 
             "dividing", " ", "it", " ", "for", " ", "the", " ", "sum", 
             "\[IndentingNewLine]", "of", " ", "all", " ", "terms", " ", "at",
              " ", "the", " ", "denominator"}], ";", " ", 
            RowBox[{
            "note", " ", "that", " ", "the", " ", "denominator", " ", 
             "contains", " ", "\[Lambda]"}]}], ",", " ", 
           RowBox[{
           "which", " ", "is", " ", "in", " ", "fact", " ", "flows", " ", 
            "of", " ", "jobs"}], ",", " ", 
           RowBox[{"rather", " ", "than", " ", "shares"}]}], "*)"}], 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
           RowBox[{"output", ":", " ", 
            RowBox[{
             RowBox[{"matrix", " ", "with", " ", "ncounties"}], "+", 
             RowBox[{"1", " ", "rows"}]}]}], ",", " ", 
           RowBox[{"and", " ", "ncounties", " ", "columns", " ", 
            RowBox[{"(", 
             RowBox[{
             "iterWtilde", " ", "is", " ", "added", " ", "as", " ", "a", " ", 
              "last", " ", "row"}], ")"}]}]}], "*)"}], "\[IndentingNewLine]", 
         RowBox[{"outcome", "=", 
          RowBox[{"Join", "[", 
           RowBox[{"iter\[Lambda]tilde", ",", 
            RowBox[{"{", "iterWtilde", "}"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", "outcome"}]}], "\[IndentingNewLine]", 
       "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{
  3.621363735204501*^9, 3.6213637956615458`*^9, {3.62136465358733*^9, 
   3.621364677140685*^9}, {3.6213648877907476`*^9, 3.6213648889178605`*^9}, {
   3.6213649257325416`*^9, 3.6213649969856663`*^9}, {3.621365030617029*^9, 
   3.621365124007367*^9}, {3.62136515443841*^9, 3.6213651622951956`*^9}, {
   3.621365291633128*^9, 3.62136535396036*^9}, {3.6213653883317966`*^9, 
   3.6213654131002736`*^9}, {3.6213654894549084`*^9, 3.621365491215084*^9}, {
   3.621365522487211*^9, 3.621365545507513*^9}, {3.6213655770576677`*^9, 
   3.621365618530814*^9}, {3.621365672656226*^9, 3.6213657217081313`*^9}, {
   3.621365753863346*^9, 3.6213657837363334`*^9}, {3.621365815878547*^9, 
   3.621365831634123*^9}, {3.6213658709220514`*^9, 3.6213659274987082`*^9}, {
   3.6213659704069986`*^9, 3.621365974532411*^9}, {3.6213660132342806`*^9, 
   3.6213660445734143`*^9}, {3.621366123584315*^9, 3.6213661335143075`*^9}, {
   3.6213661712700825`*^9, 3.621366180854041*^9}, {3.621366226499605*^9, 
   3.621366272786234*^9}, {3.6213663422221766`*^9, 3.621366368950849*^9}, {
   3.6213664014460983`*^9, 3.6213665300739594`*^9}, {3.6213665626982217`*^9, 
   3.621366624515403*^9}, {3.6213669422431726`*^9, 3.6213669760725555`*^9}, {
   3.621367178654811*^9, 3.621367209990945*^9}, 3.6213673026332083`*^9, 
   3.621367365699514*^9, 3.6214287562542753`*^9, {3.6214288819378424`*^9, 
   3.6214289442840767`*^9}, {3.6214435660483274`*^9, 
   3.6214436214418664`*^9}, {3.621443708700591*^9, 3.6214438692676463`*^9}, {
   3.6214444971024237`*^9, 3.621444524900203*^9}, {3.6214446259023027`*^9, 
   3.6214446262853403`*^9}, {3.621444777583469*^9, 3.62144477779749*^9}, 
   3.6214448243081408`*^9, {3.621444864740184*^9, 3.621444876875397*^9}, {
   3.6214449190076103`*^9, 3.621445116036311*^9}, {3.6214452817868843`*^9, 
   3.621445409476652*^9}, {3.621445498407544*^9, 3.621445505160219*^9}, {
   3.621445568643567*^9, 3.6214456089455967`*^9}, {3.6214456407947817`*^9, 
   3.621445646099312*^9}, {3.6214456802617273`*^9, 3.621445683117013*^9}, {
   3.621445721229824*^9, 3.621445757037404*^9}, {3.621445797064407*^9, 
   3.6214458451842184`*^9}, {3.621446049294627*^9, 3.62144609462516*^9}, {
   3.6214467756582565`*^9, 3.621446782456936*^9}, {3.6214472603917246`*^9, 
   3.62144727654134*^9}, {3.62144739825751*^9, 3.6214474274644303`*^9}, {
   3.621447458153499*^9, 3.6214474631770015`*^9}, {3.621447500113695*^9, 
   3.6214475723799205`*^9}, {3.6214479360672855`*^9, 
   3.6214479433380127`*^9}, {3.6214480116928473`*^9, 3.621448027810459*^9}, {
   3.6214488163043003`*^9, 3.6214488507237425`*^9}, {3.621449714950156*^9, 
   3.621449719141575*^9}, {3.6214502373893948`*^9, 3.6214502414377995`*^9}, {
   3.621450310677723*^9, 3.621450310940749*^9}, {3.6214504197126255`*^9, 
   3.621450520460699*^9}, {3.621450607407393*^9, 3.621450620230675*^9}, {
   3.621592199575161*^9, 3.621592210654161*^9}, {3.621594472396161*^9, 
   3.621594596618161*^9}, {3.6217962010304136`*^9, 3.6217963004704137`*^9}, {
   3.621797472014414*^9, 3.6217975053414135`*^9}, {3.621806833896414*^9, 
   3.6218068508194137`*^9}, {3.621849216215517*^9, 3.621849220915517*^9}, {
   3.6218522146745167`*^9, 3.6218522250515165`*^9}, {3.6235080404702044`*^9, 
   3.6235080785455885`*^9}, {3.6235084401442575`*^9, 3.623508456475421*^9}, {
   3.6235085214098496`*^9, 3.623508531672876*^9}, {3.6235089426469693`*^9, 
   3.6235089433810425`*^9}, {3.623578173278491*^9, 3.6235781759737606`*^9}, {
   3.6309312673362703`*^9, 3.630931274473984*^9}, {3.6322473232597647`*^9, 
   3.6322473234666405`*^9}, {3.632943639457246*^9, 3.6329436459608955`*^9}, {
   3.6329437211404133`*^9, 3.6329437271670156`*^9}, {3.641060657185272*^9, 
   3.6410606575752745`*^9}, {3.6410607187312727`*^9, 3.641060726424122*^9}, {
   3.641060788082331*^9, 3.6410607929219685`*^9}, {3.6410609777517776`*^9, 
   3.6410609887830486`*^9}, {3.6411267764682856`*^9, 
   3.6411267797066097`*^9}, {3.6411268800946474`*^9, 3.641126907111349*^9}, {
   3.6411275406186934`*^9, 3.641127556339265*^9}, {3.6411387759882636`*^9, 
   3.641138788987563*^9}, {3.641251844316097*^9, 3.641251867254097*^9}, {
   3.6418385500762243`*^9, 3.641838556527869*^9}, {3.641840036375839*^9, 
   3.641840097520953*^9}, {3.6526925277617526`*^9, 3.6526925322457595`*^9}, {
   3.652693964254572*^9, 3.652693967468577*^9}, {3.654247479432622*^9, 
   3.6542475415897207`*^9}, {3.6766071672268796`*^9, 3.67660716984442*^9}, {
   3.6767965985003986`*^9, 3.6767966121409183`*^9}, {3.676890775866412*^9, 
   3.676890820673975*^9}, 3.6768908746190605`*^9, {3.676896840812039*^9, 
   3.676896902235552*^9}, 3.734532415155735*^9, 3.734532477168828*^9},
 CellLabel->"In[38]:=",ExpressionUUID->"3345bcb8-88bf-4a63-9d8d-2f861913750f"]
}, Closed]],

Cell[CellGroupData[{

Cell["\<\
Iterations ( hatChanges[khat, dhat, ahat, bhat, landel,outputEvery] )\
\>", "Subsubsection",
 CellChangeTimes->{{3.6235785242302065`*^9, 3.6235785266902313`*^9}, {
   3.641060739169404*^9, 3.641060740559813*^9}, {3.64113969884454*^9, 
   3.64113971825148*^9}, 3.6526381560792203`*^9, {3.7345323519766374`*^9, 
   3.7345323582976475`*^9}},ExpressionUUID->"a03d94c5-c6e1-402b-9a96-\
9235a444219a"],

Cell["\<\
This function iterates over what and \[Lambda]hat until convergence, and \
gives the equilibrium counterfactual changes. It takes in exogenous changes \
in commuting and trade costs. The last argument indicates every how many \
iterations we want output on the iteration progress (set 0 for no output at \
all during iterations; set -1 for no output at all).\
\>", "Text",
 CellChangeTimes->{{3.621451690845726*^9, 3.621451712725914*^9}, {
   3.6214517517668176`*^9, 3.6214517717908196`*^9}, {3.6214522762902646`*^9, 
   3.6214523426829033`*^9}, {3.6411266561462545`*^9, 3.641126656457286*^9}, {
   3.641127157657401*^9, 3.641127167999435*^9}, 
   3.734532373124668*^9},ExpressionUUID->"894439f3-c31b-424b-a139-\
3b7d35ae4830"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"hatChanges", "[", 
    RowBox[{
    "khat_", ",", "dhat_", ",", "ahat_", ",", "bhat_", ",", "landel_", ",", 
     "outputEvery_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "dist", ",", "c", ",", "what", ",", "\[Lambda]hat", ",", "inWhat", ",", 
       "in\[Lambda]", ",", "out", ",", "iter\[Lambda]tilde", ",", 
       "iterWtilde", ",", "distWages", ",", "dist\[Lambda]", ",", 
       "\[IndentingNewLine]", "temp1", ",", "denRes", ",", "numRes", ",", 
       "Vbarhat", ",", "LMhat", ",", "LRhat", ",", "Qhat", ",", "temp2", ",", 
       "den", ",", "num", ",", "\[Pi]nihat", ",", "diag", ",", "Phat", ",", 
       "pricehat", ",", "realinchat"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"dist", "=", "1"}], ";", "\[IndentingNewLine]", 
      RowBox[{"c", "=", "0"}], ";", "\[IndentingNewLine]", 
      RowBox[{"what", "=", 
       RowBox[{"Table", "[", 
        RowBox[{"1", ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "ncounties"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"\[Lambda]hat", "=", "isCommuting"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"While", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"c", "<", "maxiter"}], " ", "&&", " ", 
         RowBox[{"dist", ">", "tol"}]}], ",", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"c", "=", 
          RowBox[{"c", "+", "1"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"inWhat", "=", "what"}], ";", "\[IndentingNewLine]", 
         RowBox[{"in\[Lambda]", "=", "\[Lambda]hat"}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"out", "=", 
          RowBox[{"allChangesGuess", "[", 
           RowBox[{
           "inWhat", ",", "in\[Lambda]", ",", "khat", ",", "dhat", ",", 
            "ahat", ",", "bhat", ",", "landel"}], "]"}]}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"iter\[Lambda]tilde", "=", 
          RowBox[{
           RowBox[{"out", "[", 
            RowBox[{"[", 
             RowBox[{
              RowBox[{"1", ";;", "ncounties"}], ",", "All"}], "]"}], "]"}], 
           " ", "isCommutingSp"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"iterWtilde", "=", 
          RowBox[{"out", "[", 
           RowBox[{"[", 
            RowBox[{
             RowBox[{"ncounties", "+", "1"}], ",", "All"}], "]"}], "]"}]}], 
         ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"distWages", "=", 
          RowBox[{"Max", "[", 
           RowBox[{"Abs", "[", 
            RowBox[{
             FractionBox["iterWtilde", "inWhat"], "-", "1"}], "]"}], "]"}]}], 
         ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
           RowBox[{"using", " ", "the", " ", "sparse"}], "-", 
           RowBox[{
           "array", " ", "version", " ", "of", " ", "commuting", " ", 
            "allows", " ", "saving", " ", "time"}]}], "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"dist\[Lambda]", "=", 
          RowBox[{"Max", "[", 
           RowBox[{
            RowBox[{"Abs", "[", 
             RowBox[{
              FractionBox["iter\[Lambda]tilde", 
               RowBox[{"in\[Lambda]", "+", "isCommutingSp", "-", "1"}]], " ", 
              "-", "1"}], "]"}], " ", "isCommutingSp"}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
           RowBox[{
           "the", " ", "denominator", " ", "makes", " ", "sure", " ", "that", 
            " ", "the", " ", "division", " ", "by", " ", "zero", " ", "never",
             " ", "occurs"}], ",", " ", 
           RowBox[{
            RowBox[{
            "while", " ", "preserving", " ", "the", " ", "deviations", " ", 
             "for", " ", "observed", " ", "commuting", " ", "pairs"}], ";", 
            " ", "then"}], ",", " ", 
           RowBox[{
           "the", " ", "matrix", " ", "is", " ", "multiplied", " ", "by", " ",
             "commuting", " ", "indicators", " ", "to", " ", "restore", " ", 
            "zero", " ", "change", " ", "where", " ", "there", " ", "are", 
            " ", "no", " ", "commuting", " ", "flows"}]}], "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"what", "=", 
          RowBox[{
           RowBox[{"inWhat", " ", "\[Zeta]"}], " ", "+", " ", 
           RowBox[{"iterWtilde", " ", 
            RowBox[{"(", 
             RowBox[{"1", "-", "\[Zeta]"}], ")"}]}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"\[Lambda]hat", "=", 
          RowBox[{
           RowBox[{"in\[Lambda]", "  ", "\[Zeta]"}], " ", "+", " ", 
           RowBox[{"iter\[Lambda]tilde", " ", 
            RowBox[{"(", 
             RowBox[{"1", "-", "\[Zeta]"}], ")"}]}]}]}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"dist", "=", 
          RowBox[{"Max", "[", 
           RowBox[{"{", 
            RowBox[{"distWages", ",", "dist\[Lambda]"}], "}"}], "]"}]}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"outputEvery", ">", "0"}], " ", "&&", 
            RowBox[{
             RowBox[{"Mod", "[", 
              RowBox[{"c", ",", "outputEvery"}], "]"}], "\[Equal]", "1"}]}], 
           ",", " ", 
           RowBox[{"Print", "[", 
            RowBox[{
            "\"\<Iteration \>\"", ",", "c", ",", "\"\<  concluded on \>\"", 
             ",", 
             RowBox[{"DateString", "[", "]"}], ",", " ", 
             "\"\<; distWages is \>\"", ",", "distWages", ",", 
             "\"\<; dist\[Lambda] is \>\"", ",", "dist\[Lambda]", ",", 
             "\"\<.\>\""}], "]"}]}], "]"}], ";"}]}], "\[IndentingNewLine]", 
       "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"dist", ">", "tol"}], ",", "\[IndentingNewLine]", 
        RowBox[{"Print", "[", 
         RowBox[{
         "\"\<WARNING: Max iterations reached witout satisfying the required \
tolerance. Current sup-norm distances: distWages: \>\"", ",", "distWages", 
          ",", "\"\<; dist\[Lambda]: \>\"", ",", "dist\[Lambda]", ",", 
          "\"\< ...\>\""}], "]"}], ",", "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"outputEvery", ">", 
           RowBox[{"-", "1"}]}], ",", "\[IndentingNewLine]", 
          RowBox[{"Print", "[", 
           RowBox[{
           "\"\<Convergence achieved in \>\"", ",", "c", ",", 
            "\"\< iterations on \>\"", ",", 
            RowBox[{"DateString", "[", "]"}], ",", "\"\<; distWages is \>\"", 
            ",", "distWages", ",", "\"\<; dist\[Lambda] is \>\"", ",", 
            "dist\[Lambda]", ",", "\"\< ...\>\""}], "]"}]}], 
         "\[IndentingNewLine]", "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"Computing", " ", "equilibrium", " ", "changes"}], "*)"}], 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"vbar", " ", "hat"}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"temp1", "=", " ", 
       FractionBox[
        RowBox[{"bhat", " ", "\[Lambda]"}], 
        SuperscriptBox["khat", "\[Epsilon]"]]}], " ", ";", " ", 
      "\[IndentingNewLine]", 
      RowBox[{"denRes", "=", 
       RowBox[{"temp1", ".", 
        SuperscriptBox["what", "\[Epsilon]"]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"numRes", "=", 
       RowBox[{"temp1", ".", 
        RowBox[{"(", 
         RowBox[{
          SuperscriptBox["what", 
           RowBox[{"\[Epsilon]", "+", "1"}]], " ", "workplaceWage"}], 
         ")"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Vbarhat", "=", 
       FractionBox["numRes", 
        RowBox[{"resWage", " ", "denRes"}]]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"lm", " ", "hat", " ", "and", " ", "lr", " ", "hat"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"note", ":", " ", 
         RowBox[{"\[Lambda]", " ", "are", " ", "already", " ", "flows"}]}], 
        ",", " ", 
        RowBox[{
         RowBox[{"i", ".", "e", ".", " ", "shares"}], " ", "times", " ", 
         "Lbar", " ", "in", " ", "the", " ", "equations"}]}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"temp1", "=", 
       RowBox[{"\[Lambda]", " ", "\[Lambda]hat"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"LMhat", "=", 
       FractionBox[
        RowBox[{"Total", "[", "temp1", "]"}], "workplaceEmp"]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"LRhat", "=", 
       FractionBox[
        RowBox[{"Total", "[", 
         RowBox[{"Transpose", "[", "temp1", "]"}], "]"}], "resEmp"]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"q", " ", "hat"}], "*)"}], "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"Qhat", "=", 
       SuperscriptBox[
        RowBox[{"(", 
         FractionBox[
          RowBox[{
           RowBox[{"resIncome", " ", "Vbarhat", " ", "LRhat"}], "+", 
           "deficit"}], 
          RowBox[{"resIncome", "+", "deficit"}]], ")"}], 
        RowBox[{"1", "/", 
         RowBox[{"(", 
          RowBox[{"1", "+", "landel"}], ")"}]}]]}], ";", " ", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"\[Pi]ni", " ", "hat"}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"temp1", "=", 
       RowBox[{"\[Pi]niOnlyTrading", " ", 
        SuperscriptBox["dhat", 
         RowBox[{"(", 
          RowBox[{"1", "-", "\[Sigma]"}], ")"}]]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"temp2", "=", 
       RowBox[{"LMhat", " ", 
        SuperscriptBox[
         RowBox[{"(", 
          FractionBox["what", "ahat"], ")"}], 
         RowBox[{"1", "-", "\[Sigma]"}]]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"den", "=", 
       RowBox[{"temp2", ".", "temp1"}]}], ";", " ", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"note", " ", "that", " ", "left"}], "-", 
        RowBox[{
        "product", " ", "effectively", " ", "gives", " ", "the", " ", 
         "transpose", " ", "of", " ", "temp1", " ", "times", " ", 
         RowBox[{"temp2", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"num", "=", 
       RowBox[{
        SuperscriptBox["dhat", 
         RowBox[{"(", 
          RowBox[{"1", "-", "\[Sigma]"}], ")"}]], " ", "temp2"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"\[Pi]nihat", "=", 
       RowBox[{"Transpose", "[", 
        FractionBox[
         RowBox[{"Transpose", "[", "num", "]"}], "den"], "  ", "]"}]}], " ", 
      ";", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{
        "the", " ", "term", " ", "inside", " ", "divides", " ", "each", " ", 
         "column", " ", "by", " ", "the", " ", "correspondent", " ", 
         "element", " ", "of", " ", "the", " ", "denominator"}], ";", " ", 
        RowBox[{
        "it", " ", "then", " ", "brings", " ", "the", " ", "matrix", " ", 
         "in", " ", "the", " ", "original", " ", "form"}]}], "*)"}], 
      "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"P", " ", "hat"}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"diag", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"\[Pi]nihat", "[", 
          RowBox[{"[", 
           RowBox[{"i", ",", "i"}], "]"}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "ncounties"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Phat", "=", 
       RowBox[{
        FractionBox["what", "ahat"], 
        SuperscriptBox[
         RowBox[{"(", 
          FractionBox["LMhat", "diag"], ")"}], 
         RowBox[{"1", "/", 
          RowBox[{"(", 
           RowBox[{"1", "-", "\[Sigma]"}], ")"}]}]]}]}], "  ", ";", " ", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"price", " ", "index", " ", "hat"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"pricehat", "=", 
       RowBox[{
        SuperscriptBox["Phat", "\[Alpha]"], 
        SuperscriptBox["Qhat", 
         RowBox[{"1", "-", "\[Alpha]"}]]}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"real", " ", "income", " ", "of", " ", "residents"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"realinchat", "=", 
       FractionBox["Vbarhat", "pricehat"]}], ";", " ", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"outputEvery", ">", 
         RowBox[{"-", "1"}]}], ",", 
        RowBox[{"Print", "[", 
         RowBox[{"\"\<Counterfactuals completed on \>\"", ",", 
          RowBox[{"DateString", "[", "]"}], ",", "\"\<.\>\""}], "]"}]}], 
       "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"{", 
       RowBox[{
       "what", ",", "Vbarhat", ",", "realinchat", ",", "LMhat", ",", "LRhat", 
        ",", "Qhat", ",", "Phat", ",", "pricehat", ",", "\[Lambda]hat", ",", 
        "\[Pi]nihat", ",", "c", ",", "distWages", ",", "dist\[Lambda]"}], 
       "}"}]}]}], "\[IndentingNewLine]", "\[IndentingNewLine]", "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.6214517760782485`*^9, 3.621452092164854*^9}, 
   3.6214521577034073`*^9, {3.621452347571392*^9, 3.621452348404475*^9}, {
   3.621453679225544*^9, 3.621453706868308*^9}, {3.621595174018161*^9, 
   3.621595378443161*^9}, {3.6215954172481613`*^9, 3.621595418776161*^9}, {
   3.6215967798071613`*^9, 3.621597052551161*^9}, {3.621597169773161*^9, 
   3.621597203427161*^9}, {3.6215974704348173`*^9, 3.6215976135569816`*^9}, {
   3.621597663537888*^9, 3.6215976640531964`*^9}, {3.621597783993651*^9, 
   3.621597792486063*^9}, {3.6215978380934644`*^9, 3.621598026625425*^9}, 
   3.6215982836831484`*^9, {3.6215983718250275`*^9, 3.621598389847432*^9}, {
   3.6215987984846926`*^9, 3.6215988978756304`*^9}, {3.6217979006564136`*^9, 
   3.6217979144264135`*^9}, {3.6217979845894136`*^9, 
   3.6217979864754133`*^9}, {3.6218069545304136`*^9, 
   3.6218070047724133`*^9}, {3.6218491859375167`*^9, 
   3.6218491905625167`*^9}, {3.621852318370517*^9, 3.621852329229517*^9}, {
   3.623507226819772*^9, 3.6235072612642164`*^9}, {3.6235098170903783`*^9, 
   3.6235098286954985`*^9}, {3.62350986951591*^9, 3.6235098851195354`*^9}, {
   3.6235099302880516`*^9, 3.6235099352955523`*^9}, {3.623537696198702*^9, 
   3.6235377077708592`*^9}, {3.6235377459866805`*^9, 
   3.6235378213679943`*^9}, {3.630931379430478*^9, 3.6309313802615614`*^9}, {
   3.6322473639193544`*^9, 3.6322473641262302`*^9}, {3.632943778133112*^9, 
   3.632943797191017*^9}, {3.641060800378816*^9, 3.641060816009919*^9}, {
   3.641138832067871*^9, 3.6411388523639*^9}, 3.641251893875097*^9, {
   3.6418403598931875`*^9, 3.641840430600258*^9}, {3.652694165168885*^9, 
   3.652694165698886*^9}, {3.65424756869676*^9, 3.654247586026786*^9}, {
   3.6766072063389807`*^9, 3.6766072144651055`*^9}, {3.6767966913950343`*^9, 
   3.676796706058555*^9}, {3.6767967545553184`*^9, 3.676796758922826*^9}, {
   3.6767971862237806`*^9, 3.67679719301729*^9}, {3.676891243751071*^9, 
   3.6768912567728157`*^9}, {3.6768969328073006`*^9, 
   3.6768969544165363`*^9}, {3.7345327995953164`*^9, 3.734532802643321*^9}, 
   3.734537737177843*^9},ExpressionUUID->"5ac0c923-1d37-47b3-8c66-\
029b5f6c66b6"]
}, Closed]]
}, Closed]],

Cell[CellGroupData[{

Cell["Only changes in productivity", "Section",
 CellChangeTimes->{{3.641060214793125*^9, 3.6410602198077574`*^9}, {
  3.6411398100946636`*^9, 
  3.641139810598714*^9}},ExpressionUUID->"477459ed-1ea0-409c-ba09-\
f9fee7276c0c"],

Cell[CellGroupData[{

Cell["Guess Update", "Subsubsection",
 CellChangeTimes->{{3.6235777030954776`*^9, 3.623577708929061*^9}, {
   3.632841013974019*^9, 3.632841034415063*^9}, 3.6328451638514557`*^9, {
   3.6410603779811935`*^9, 3.6410603800886087`*^9}, 3.641061339157375*^9, 
   3.641061373298402*^9},ExpressionUUID->"57da4884-ceef-4c79-a470-\
3dd56452be56"],

Cell[BoxData[
 RowBox[{
  RowBox[{"prodChangesGuess", "=", 
   RowBox[{"Compile", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"inWhat", ",", "_Real", ",", "1"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"in\[Lambda]", ",", "_Real", ",", "2"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"ahat", ",", "_Real", ",", "1"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"ones", ",", "_Real", ",", "1"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"\[Chi]", ",", "_Real", ",", "1"}], "}"}]}], "}"}], ",", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"prodChangesGuessMod", "=", 
      RowBox[{"Module", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "iterVbar", ",", "iterLM", ",", "iterLR", ",", "iterQ", ",", 
          "iter\[Pi]ni", ",", "iterP", ",", "iter\[Lambda]tilde", ",", 
          "iterWtilde", ",", "distWages", ",", "dist\[Lambda]", ",", "wout", 
          ",", "\[Lambda]out", ",", "diag", ",", "\[IndentingNewLine]", 
          "temp1", ",", "temp2", ",", "temp3", ",", "temp4", ",", "temp5", 
          ",", "temp6", ",", "denRes", ",", "numRes", ",", "den", ",", "num", 
          ",", "den2", ",", "temp7", ",", "temp8", ",", "outcome"}], "}"}], 
        ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{"vbar", " ", "hat"}], "*)"}], "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"denRes", "=", 
          RowBox[{"\[Lambda]", ".", 
           SuperscriptBox["inWhat", "\[Epsilon]"]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"numRes", "=", 
          RowBox[{"\[Lambda]", ".", 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["inWhat", 
              RowBox[{"\[Epsilon]", "+", "1"}]], " ", "workplaceWage"}], 
            ")"}]}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"iterVbar", "=", 
          FractionBox["numRes", 
           RowBox[{"resWage", " ", "denRes"}]]}], ";", "\[IndentingNewLine]", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{"lm", " ", "hat", " ", "and", " ", "lr", " ", "hat"}], 
          "*)"}], "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
           RowBox[{"note", ":", " ", 
            RowBox[{"\[Lambda]", " ", "are", " ", "already", " ", "flows"}]}],
            ",", " ", 
           RowBox[{
            RowBox[{"i", ".", "e", ".", " ", "shares"}], " ", "times", " ", 
            "Lbar", " ", "in", " ", "the", " ", "equations"}]}], "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"temp1", "=", 
          RowBox[{"\[Lambda]", " ", "in\[Lambda]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"iterLM", "=", 
          FractionBox[
           RowBox[{"Total", "[", "temp1", "]"}], "workplaceEmp"]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"iterLR", "=", 
          FractionBox[
           RowBox[{"Total", "[", 
            RowBox[{"Transpose", "[", "temp1", "]"}], "]"}], "resEmp"]}], ";",
          "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{"q", " ", "hat"}], "*)"}], "\[IndentingNewLine]", 
         "\[IndentingNewLine]", 
         RowBox[{"iterQ", "=", 
          SuperscriptBox[
           RowBox[{"(", 
            FractionBox[
             RowBox[{
              RowBox[{"resIncome", " ", "iterVbar", " ", "iterLR"}], "+", 
              "deficit"}], 
             RowBox[{"resIncome", "+", "deficit"}]], " ", ")"}], 
           RowBox[{"1", "/", 
            RowBox[{"(", 
             RowBox[{"1", "+", "\[Chi]"}], ")"}]}]]}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{"\[Pi]ni", " ", "hat"}], "*)"}], "\[IndentingNewLine]", 
         RowBox[{"temp2", "=", 
          RowBox[{"iterLM", " ", 
           SuperscriptBox[
            RowBox[{"(", 
             FractionBox["inWhat", "ahat"], ")"}], 
            RowBox[{"1", "-", "\[Sigma]"}]]}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"den", "=", 
          RowBox[{"temp2", ".", "\[Pi]niOnlyTrading"}]}], ";", " ", 
         RowBox[{"(*", 
          RowBox[{
           RowBox[{"note", " ", "that", " ", "left"}], "-", 
           RowBox[{
           "product", " ", "effectively", " ", "gives", " ", "the", " ", 
            "transpose", " ", "of", " ", "temp1", " ", "times", " ", 
            RowBox[{"temp2", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
         RowBox[{"num", "=", 
          RowBox[{"Outer", "[", 
           RowBox[{"Times", ",", "temp2", ",", "ones"}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"iter\[Pi]ni", "=", 
          RowBox[{"Transpose", "[", 
           FractionBox[
            RowBox[{"Transpose", "[", "num", "]"}], "den"], "  ", "]"}]}], 
         " ", ";", 
         RowBox[{"(*", 
          RowBox[{
           RowBox[{
           "the", " ", "term", " ", "inside", " ", "divides", " ", "each", 
            " ", "column", " ", "by", " ", "the", " ", "correspondent", " ", 
            "element", " ", "of", " ", "the", " ", "denominator"}], ";", " ", 
           RowBox[{
           "it", " ", "then", " ", "brings", " ", "the", " ", "matrix", " ", 
            "in", " ", "the", " ", "original", " ", "form"}]}], "*)"}], 
         "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{"P", " ", "hat"}], "*)"}], "\[IndentingNewLine]", 
         RowBox[{"diag", "=", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{"iter\[Pi]ni", "[", 
             RowBox[{"[", 
              RowBox[{"i", ",", "i"}], "]"}], "]"}], ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", "1", ",", "ncounties"}], "}"}]}], "]"}]}], ";",
          "\[IndentingNewLine]", 
         RowBox[{"iterP", "=", 
          RowBox[{
           FractionBox["inWhat", "ahat"], 
           SuperscriptBox[
            RowBox[{"(", 
             FractionBox["iterLM", "diag"], ")"}], 
            RowBox[{"1", "/", 
             RowBox[{"(", 
              RowBox[{"1", "-", "\[Sigma]"}], ")"}]}]]}]}], "  ", ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
           RowBox[{"w", " ", "hat"}], ",", " ", 
           RowBox[{"next", " ", "iteration"}]}], "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"temp1", "=", 
          RowBox[{"\[Pi]niOnlyTrading", " ", "iter\[Pi]ni"}]}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"temp4", "=", 
          RowBox[{
           RowBox[{"iterVbar", " ", "iterLR", "  ", "resIncome"}], "+", 
           "deficit"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"iterWtilde", "=", 
          FractionBox[
           RowBox[{"temp1", ".", "temp4"}], 
           RowBox[{"laborIncome", " ", "iterLM"}]]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"iterWtilde", "=", 
          FractionBox["iterWtilde", 
           RowBox[{"Mean", "[", "iterWtilde", "]"}]]}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
           RowBox[{"\[Lambda]", " ", "hat"}], ",", " ", 
           RowBox[{"next", " ", "iteration"}]}], "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"temp7", "=", 
          RowBox[{
           SuperscriptBox["iterP", 
            RowBox[{"-", "\[Alpha]"}]], " ", 
           SuperscriptBox["iterQ", 
            RowBox[{
             RowBox[{"-", "1"}], "+", "\[Alpha]"}]]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"temp6", "=", 
          SuperscriptBox[
           RowBox[{"(", 
            RowBox[{"Outer", "[", 
             RowBox[{"Times", ",", "temp7", ",", "inWhat"}], "]"}], ")"}], 
           "\[Epsilon]"]}], ";", "\[IndentingNewLine]", 
         RowBox[{"den2", "=", 
          RowBox[{"Total", "[", 
           RowBox[{"Total", "[", 
            RowBox[{"\[Lambda]", " ", "temp6"}], "]"}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"iter\[Lambda]tilde", "=", 
          FractionBox[
           RowBox[{"(", 
            RowBox[{"temp6", " ", "population"}], ")"}], "den2"]}], " ", ";", 
         "  ", 
         RowBox[{"(*", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{
             "to", " ", "limit", " ", "accumulation", " ", "of", " ", 
              "numerical", " ", "errors"}], " ", "-", " ", 
             RowBox[{
             "unconditional", " ", "shares", " ", "of", " ", "commuting", " ",
               "\[IndentingNewLine]", "have", " ", "a", " ", "very", " ", 
              "small", " ", "order", " ", "of", " ", "magnitude"}], " ", "-", 
             " ", 
             RowBox[{
             "we", " ", "predict", " ", "new", " ", "commuting", " ", "flows",
               " ", "in", " ", "#", " ", "of", " ", "jobs"}]}], ";", " ", 
            "hence"}], ",", " ", 
           RowBox[{
            RowBox[{
            "the", " ", "numerator", " ", "is", " ", "multiplied", " ", "by", 
             " ", "the", " ", "population", " ", "level", " ", "before", " ", 
             "dividing", " ", "it", " ", "for", " ", "the", " ", "sum", 
             "\[IndentingNewLine]", "of", " ", "all", " ", "terms", " ", "at",
              " ", "the", " ", "denominator"}], ";", " ", 
            RowBox[{
            "note", " ", "that", " ", "the", " ", "denominator", " ", 
             "contains", " ", "\[Lambda]"}]}], ",", " ", 
           RowBox[{
           "which", " ", "is", " ", "in", " ", "fact", " ", "flows", " ", 
            "of", " ", "jobs"}], ",", " ", 
           RowBox[{"rather", " ", "than", " ", "shares"}]}], "*)"}], 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", "output", "*)"}], "\[IndentingNewLine]", 
         RowBox[{"outcome", "=", 
          RowBox[{"Join", "[", 
           RowBox[{"iter\[Lambda]tilde", ",", 
            RowBox[{"{", "iterWtilde", "}"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", "outcome"}]}], "\[IndentingNewLine]", 
       "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.6235777207472425`*^9, 3.623577830251192*^9}, {
   3.6235778652846947`*^9, 3.623577891929359*^9}, {3.623578180921255*^9, 
   3.623578182975461*^9}, {3.623578217861949*^9, 3.623578265031666*^9}, 
   3.623578567450639*^9, {3.6235787934228983`*^9, 3.623578798042945*^9}, {
   3.6235790896458607`*^9, 3.623579128866253*^9}, {3.6309313340729427`*^9, 
   3.6309313351410494`*^9}, {3.632247344433053*^9, 3.6322473447218795`*^9}, {
   3.641061163205803*^9, 3.6410611955044127`*^9}, {3.6410612892508445`*^9, 
   3.641061294670481*^9}, {3.6411391496346245`*^9, 3.6411391514198027`*^9}, {
   3.6411393808697453`*^9, 3.6411393831559744`*^9}, {3.6411394338550434`*^9, 
   3.641139435710229*^9}, {3.641252005584097*^9, 3.6412520112450967`*^9}, {
   3.6418394576219697`*^9, 3.641839483481555*^9}, {3.641839542573464*^9, 
   3.6418395581910257`*^9}, 3.6418396152257285`*^9, {3.6418397039746027`*^9, 
   3.6418397058277874`*^9}, {3.6418397690201063`*^9, 3.641839782102414*^9}, {
   3.676606987171113*^9, 3.67660701753008*^9}, 3.67679692156424*^9, {
   3.6768916308119483`*^9, 3.6768916561343966`*^9}, {3.6768971261806903`*^9, 
   3.6768971438453045`*^9}, 3.734532582687991*^9, 3.734532630401061*^9},
 CellLabel->"In[40]:=",ExpressionUUID->"037acceb-3c8f-4bb2-ada9-089124e60a3b"]
}, Closed]],

Cell[CellGroupData[{

Cell["Iterations ( hatChangesA[ahat, landel,outputEvery] )", "Subsubsection",
 CellChangeTimes->{{3.62357854253039*^9, 3.62357854853045*^9}, {
  3.64106037428297*^9, 3.641060375656779*^9}, {3.6410613799128437`*^9, 
  3.641061381504054*^9}, {3.6411395719768543`*^9, 3.641139575952252*^9}, {
  3.641139678435499*^9, 3.6411396812757835`*^9}, {3.734532650736091*^9, 
  3.734532651876093*^9}},ExpressionUUID->"26c68960-3248-484a-ba3d-\
0677366ad4d3"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"hatChangesA", "[", 
    RowBox[{"ahat_", ",", "landel_", ",", "outputEvery_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "dist", ",", "c", ",", "what", ",", "\[Lambda]hat", ",", "inWhat", ",", 
       "in\[Lambda]", ",", "out", ",", "iter\[Lambda]tilde", ",", 
       "iterWtilde", ",", "distWages", ",", "dist\[Lambda]", ",", "ones", ",",
        "\[IndentingNewLine]", "temp1", ",", "denRes", ",", "numRes", ",", 
       "Vbarhat", ",", "LMhat", ",", "LRhat", ",", "Qhat", ",", "temp2", ",", 
       "den", ",", "num", ",", "\[Pi]nihat", ",", "diag", ",", "Phat", ",", 
       "pricehat", ",", "realinchat"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"dist", "=", "1"}], ";", "\[IndentingNewLine]", 
      RowBox[{"c", "=", "0"}], ";", "\[IndentingNewLine]", 
      RowBox[{"what", "=", 
       RowBox[{"Table", "[", 
        RowBox[{"1", ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "ncounties"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"\[Lambda]hat", "=", "isCommuting"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"ones", "=", 
       RowBox[{"Table", "[", 
        RowBox[{"1", ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "ncounties"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"While", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"c", "<", "maxiter"}], " ", "&&", " ", 
         RowBox[{"dist", ">", "tol"}]}], ",", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"c", "=", 
          RowBox[{"c", "+", "1"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"inWhat", "=", "what"}], ";", "\[IndentingNewLine]", 
         RowBox[{"in\[Lambda]", "=", "\[Lambda]hat"}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"out", "=", 
          RowBox[{"prodChangesGuess", "[", 
           RowBox[{
           "inWhat", ",", "in\[Lambda]", ",", "ahat", ",", "ones", ",", 
            "landel"}], "]"}]}], ";", "\[IndentingNewLine]", 
         "\[IndentingNewLine]", 
         RowBox[{"iter\[Lambda]tilde", "=", 
          RowBox[{
           RowBox[{"out", "[", 
            RowBox[{"[", 
             RowBox[{
              RowBox[{"1", ";;", "ncounties"}], ",", "All"}], "]"}], "]"}], 
           " ", "isCommutingSp"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"iterWtilde", "=", 
          RowBox[{"out", "[", 
           RowBox[{"[", 
            RowBox[{
             RowBox[{"ncounties", "+", "1"}], ",", "All"}], "]"}], "]"}]}], 
         ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"distWages", "=", 
          RowBox[{"Max", "[", 
           RowBox[{"Abs", "[", 
            RowBox[{
             FractionBox["iterWtilde", "inWhat"], "-", "1"}], "]"}], "]"}]}], 
         ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
           RowBox[{"using", " ", "the", " ", "sparse"}], "-", 
           RowBox[{
           "array", " ", "version", " ", "of", " ", "commuting", " ", 
            "allows", " ", "saving", " ", "time"}]}], "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"dist\[Lambda]", "=", 
          RowBox[{"Max", "[", 
           RowBox[{
            RowBox[{"Abs", "[", 
             RowBox[{
              FractionBox["iter\[Lambda]tilde", 
               RowBox[{"in\[Lambda]", "+", "isCommutingSp", "-", "1"}]], " ", 
              "-", "1"}], "]"}], " ", "isCommutingSp"}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
           RowBox[{
           "the", " ", "denominator", " ", "makes", " ", "sure", " ", "that", 
            " ", "the", " ", "division", " ", "by", " ", "zero", " ", "never",
             " ", "occurs"}], ",", " ", 
           RowBox[{
            RowBox[{
            "while", " ", "preserving", " ", "the", " ", "deviations", " ", 
             "for", " ", "observed", " ", "commuting", " ", "pairs"}], ";", 
            " ", "then"}], ",", " ", 
           RowBox[{
           "the", " ", "matrix", " ", "is", " ", "multiplied", " ", "by", " ",
             "commuting", " ", "indicators", " ", "to", " ", "restore", " ", 
            "zero", " ", "change", " ", "where", " ", "there", " ", "are", 
            " ", "no", " ", "commuting", " ", "flows"}]}], "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"what", "=", 
          RowBox[{
           RowBox[{"inWhat", " ", "\[Zeta]"}], " ", "+", " ", 
           RowBox[{"iterWtilde", " ", 
            RowBox[{"(", 
             RowBox[{"1", "-", "\[Zeta]"}], ")"}]}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"\[Lambda]hat", "=", 
          RowBox[{
           RowBox[{"in\[Lambda]", "  ", "\[Zeta]"}], " ", "+", " ", 
           RowBox[{"iter\[Lambda]tilde", " ", 
            RowBox[{"(", 
             RowBox[{"1", "-", "\[Zeta]"}], ")"}]}]}]}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"dist", "=", 
          RowBox[{"Max", "[", 
           RowBox[{"{", 
            RowBox[{"distWages", ",", "dist\[Lambda]"}], "}"}], "]"}]}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"outputEvery", ">", "0"}], " ", "&&", 
            RowBox[{
             RowBox[{"Mod", "[", 
              RowBox[{"c", ",", "outputEvery"}], "]"}], "\[Equal]", "1"}]}], 
           ",", " ", 
           RowBox[{"Print", "[", 
            RowBox[{
            "\"\<Iteration \>\"", ",", "c", ",", "\"\<  concluded on \>\"", 
             ",", 
             RowBox[{"DateString", "[", "]"}], ",", " ", 
             "\"\<; distWages is \>\"", ",", "distWages", ",", 
             "\"\<; dist\[Lambda] is \>\"", ",", "dist\[Lambda]", ",", 
             "\"\<.\>\""}], "]"}]}], "]"}], ";"}]}], "\[IndentingNewLine]", 
       "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"dist", ">", "tol"}], ",", "\[IndentingNewLine]", 
        RowBox[{"Print", "[", 
         RowBox[{
         "\"\<WARNING: Max iterations reached witout satisfying the required \
tolerance. Current sup-norm distances: distWages: \>\"", ",", "distWages", 
          ",", "\"\<; dist\[Lambda]: \>\"", ",", "dist\[Lambda]", ",", 
          "\"\< ...\>\""}], "]"}], ",", "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"outputEvery", ">", 
           RowBox[{"-", "1"}]}], ",", "\[IndentingNewLine]", 
          RowBox[{"Print", "[", 
           RowBox[{
           "\"\<Convergence achieved in \>\"", ",", "c", ",", 
            "\"\< iterations on \>\"", ",", 
            RowBox[{"DateString", "[", "]"}], ",", "\"\<; distWages is \>\"", 
            ",", "distWages", ",", "\"\<; dist\[Lambda] is \>\"", ",", 
            "dist\[Lambda]", ",", "\"\< ...\>\""}], "]"}]}], 
         "\[IndentingNewLine]", "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"Computing", " ", "equilibrium", " ", "changes"}], "*)"}], 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"vbar", " ", "hat"}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"denRes", "=", 
       RowBox[{"\[Lambda]", ".", 
        SuperscriptBox["what", "\[Epsilon]"]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"numRes", "=", 
       RowBox[{"\[Lambda]", ".", 
        RowBox[{"(", 
         RowBox[{
          SuperscriptBox["what", 
           RowBox[{"\[Epsilon]", "+", "1"}]], " ", "workplaceWage"}], 
         ")"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Vbarhat", "=", 
       FractionBox["numRes", 
        RowBox[{"resWage", " ", "denRes"}]]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"lm", " ", "hat", " ", "and", " ", "lr", " ", "hat"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"note", ":", " ", 
         RowBox[{"\[Lambda]", " ", "are", " ", "already", " ", "flows"}]}], 
        ",", " ", 
        RowBox[{
         RowBox[{"i", ".", "e", ".", " ", "shares"}], " ", "times", " ", 
         "Lbar", " ", "in", " ", "the", " ", "equations"}]}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"temp1", "=", 
       RowBox[{"\[Lambda]", " ", "\[Lambda]hat"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"LMhat", "=", 
       FractionBox[
        RowBox[{"Total", "[", "temp1", "]"}], "workplaceEmp"]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"LRhat", "=", 
       FractionBox[
        RowBox[{"Total", "[", 
         RowBox[{"Transpose", "[", "temp1", "]"}], "]"}], "resEmp"]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"q", " ", "hat"}], "*)"}], "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"Qhat", "=", 
       SuperscriptBox[
        RowBox[{"(", 
         FractionBox[
          RowBox[{
           RowBox[{"resIncome", " ", "Vbarhat", " ", "LRhat"}], "+", 
           "deficit"}], 
          RowBox[{"resIncome", "+", "deficit"}]], " ", ")"}], 
        RowBox[{"1", "/", 
         RowBox[{"(", 
          RowBox[{"1", "+", "landel"}], ")"}]}]]}], ";", "  ", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"\[Pi]ni", " ", "hat"}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"temp2", "=", 
       RowBox[{"LMhat", " ", 
        SuperscriptBox[
         RowBox[{"(", 
          FractionBox["what", "ahat"], ")"}], 
         RowBox[{"1", "-", "\[Sigma]"}]]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"den", "=", 
       RowBox[{"temp2", ".", "\[Pi]niOnlyTrading"}]}], ";", " ", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"note", " ", "that", " ", "left"}], "-", 
        RowBox[{
        "product", " ", "effectively", " ", "gives", " ", "the", " ", 
         "transpose", " ", "of", " ", "temp1", " ", "times", " ", 
         RowBox[{"temp2", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"num", "=", 
       RowBox[{"Outer", "[", 
        RowBox[{"Times", ",", " ", "temp2", ",", "ones"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"\[Pi]nihat", "=", 
       RowBox[{"Transpose", "[", 
        FractionBox[
         RowBox[{"Transpose", "[", "num", "]"}], "den"], "  ", "]"}]}], " ", 
      ";", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{
        "the", " ", "term", " ", "inside", " ", "divides", " ", "each", " ", 
         "column", " ", "by", " ", "the", " ", "correspondent", " ", 
         "element", " ", "of", " ", "the", " ", "denominator"}], ";", " ", 
        RowBox[{
        "it", " ", "then", " ", "brings", " ", "the", " ", "matrix", " ", 
         "in", " ", "the", " ", "original", " ", "form"}]}], "*)"}], 
      "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"P", " ", "hat"}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"diag", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"\[Pi]nihat", "[", 
          RowBox[{"[", 
           RowBox[{"i", ",", "i"}], "]"}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "ncounties"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Phat", "=", 
       RowBox[{
        FractionBox["what", "ahat"], 
        SuperscriptBox[
         RowBox[{"(", 
          FractionBox["LMhat", "diag"], ")"}], 
         RowBox[{"1", "/", 
          RowBox[{"(", 
           RowBox[{"1", "-", "\[Sigma]"}], ")"}]}]]}]}], "  ", ";", " ", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"price", " ", "index", " ", "hat"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"pricehat", "=", 
       RowBox[{
        SuperscriptBox["Phat", "\[Alpha]"], 
        SuperscriptBox["Qhat", 
         RowBox[{"1", "-", "\[Alpha]"}]]}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"real", " ", "income", " ", "of", " ", "residents"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"realinchat", "=", 
       FractionBox["Vbarhat", "pricehat"]}], ";", " ", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"outputEvery", ">", 
         RowBox[{"-", "1"}]}], ",", 
        RowBox[{"Print", "[", 
         RowBox[{"\"\<Counterfactuals completed on \>\"", ",", 
          RowBox[{"DateString", "[", "]"}], ",", "\"\<.\>\""}], "]"}]}], 
       "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"{", 
       RowBox[{
       "what", ",", "Vbarhat", ",", "realinchat", ",", "LMhat", ",", "LRhat", 
        ",", "Qhat", ",", "Phat", ",", "pricehat", ",", "\[Lambda]hat", ",", 
        "\[Pi]nihat", ",", "c", ",", "distWages", ",", "dist\[Lambda]"}], 
       "}"}]}]}], "\[IndentingNewLine]", "\[IndentingNewLine]", "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{
  3.623578551170476*^9, {3.623579278267747*^9, 3.623579451349478*^9}, {
   3.6235795944809093`*^9, 3.6235795982309465`*^9}, {3.6243034236329203`*^9, 
   3.624303493881981*^9}, {3.6309314262891636`*^9, 3.6309314267712116`*^9}, {
   3.6322473759821124`*^9, 3.6322473762369595`*^9}, {3.6410612219673867`*^9, 
   3.6410612556328115`*^9}, {3.6411395082744846`*^9, 3.6411395100656643`*^9}, 
   3.6411425074073677`*^9, 3.641252027283097*^9, {3.641839914705673*^9, 
   3.641839938707073*^9}, {3.676607105682934*^9, 3.676607122598694*^9}, {
   3.67679703368085*^9, 3.676797036291854*^9}, {3.676797066674898*^9, 
   3.6767970691149015`*^9}, {3.6767971085574584`*^9, 3.676797112583465*^9}, {
   3.676891847734356*^9, 3.676891866408424*^9}, {3.6768971783995233`*^9, 
   3.676897194487121*^9}, 3.734532686474145*^9, 
   3.7345391561089935`*^9},ExpressionUUID->"5b646cda-2598-44ba-b4d3-\
3ddb29b70c4d"]
}, Closed]]
}, Closed]]
}, Closed]],

Cell[CellGroupData[{

Cell["Other functions", "Subchapter",
 CellChangeTimes->{{3.641208791287963*^9, 
  3.641208793288163*^9}},ExpressionUUID->"a1d9e06a-5579-45e7-9c39-\
0a1afd7ac443"],

Cell[CellGroupData[{

Cell["Productivity shocks to a set of cz", "Section",
 CellChangeTimes->{{3.641208796167451*^9, 3.6412088220960436`*^9}, {
  3.7345327424472294`*^9, 
  3.7345327425672293`*^9}},ExpressionUUID->"bf110bf6-25d7-4f6a-a77e-\
6c9e285eb123"],

Cell["\<\
This function is used to simulate productivity shocks to one cz (or a set of \
cz) inside a loop. It saves outcomes for all the economy with a given set of \
shocks, plus statistics on convergence used to check that all iterations \
concluded correctly.
It is used in 5% productivity shocks to counties and commuting zones, for \
example.\
\>", "Text",
 CellChangeTimes->{{3.6412088355293865`*^9, 3.641208953564189*^9}, {
  3.7345327400052257`*^9, 
  3.7345327414062276`*^9}},ExpressionUUID->"3b282304-bdaf-4404-b9bb-\
3e464137669b"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"countyProdShock", "[", 
    RowBox[{"rep_", ",", "prodChange_", ",", "landel_"}], "]"}], ":=", 
   RowBox[{"Module", "[", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "outcome", ",", "out", ",", "filename", ",", "caseN", ",", "repN", ",", 
       "dataOutTreat", ",", "dataOutControl", ",", "measuredProdhat", ",", 
       "shipmentsHat", ",", "allData", ",", "treatment", ",", "countyline", 
       ",", "\[IndentingNewLine]", "whatOut", ",", "VbarhatOut", ",", 
       "realinchatOut", ",", "LMhatOut", ",", "LRhatOut", ",", "QhatOut", ",",
        "PhatOut", ",", "pricehatOut", ",", "\[Lambda]hatOut", ",", 
       "\[Pi]nihatOut", ",", "\[Pi]nnhat", ",", "c", ",", "distWages", ",", 
       "dist\[Lambda]", ",", "replication"}], "}"}], ",", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"computing", " ", "outcome"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"outcome", "=", 
       RowBox[{"hatChangesA", "[", 
        RowBox[{"prodChange", ",", "landel", ",", 
         RowBox[{"-", "1"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"ALL", " ", "COUNTIES", " ", "OUTCOMES"}], "*)"}], 
      "\[IndentingNewLine]", "\t", 
      RowBox[{"(*", 
       RowBox[{"storing", " ", "all", " ", "counties", " ", "outcome"}], 
       "*)"}], "\[IndentingNewLine]", "\t", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "whatOut", ",", "VbarhatOut", ",", "realinchatOut", ",", "LMhatOut", 
         ",", "LRhatOut", ",", "QhatOut", ",", "PhatOut", ",", "pricehatOut", 
         ",", "\[Lambda]hatOut", ",", "\[Pi]nihatOut", ",", "c", ",", 
         "distWages", ",", "dist\[Lambda]"}], "}"}], "=", 
       RowBox[{"outcome", "-", "1"}]}], ";", "\[IndentingNewLine]", "\t", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"c", ",", "distWages", ",", "dist\[Lambda]"}], "}"}], "=", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"c", ",", "distWages", ",", "dist\[Lambda]"}], "}"}], "+", 
        "1"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", "\t", 
      RowBox[{"\[Lambda]hatOut", "=", 
       RowBox[{"Diagonal", "[", "\[Lambda]hatOut", "]"}]}], ";", " ", 
      RowBox[{"(*", 
       RowBox[{"own", " ", "commuting", " ", "change"}], "*)"}], 
      "\[IndentingNewLine]", "\t", 
      RowBox[{"\[Pi]nihatOut", "=", 
       RowBox[{"Diagonal", "[", "\[Pi]nihatOut", "]"}]}], ";", 
      RowBox[{"(*", 
       RowBox[{"own", " ", "trade", " ", "share", " ", "change"}], "*)"}], 
      "\[IndentingNewLine]", "\t", 
      RowBox[{"measuredProdhat", "=", 
       RowBox[{
        RowBox[{
         SuperscriptBox[
          RowBox[{"(", 
           FractionBox[
            RowBox[{"LMhatOut", "+", "1"}], 
            RowBox[{"\[Pi]nihatOut", "+", "1"}]], ")"}], 
          RowBox[{"1", "/", 
           RowBox[{"(", 
            RowBox[{"\[Sigma]", "-", "1"}], ")"}]}]], "prodChange"}], "-", 
        "1"}]}], ";", 
      RowBox[{"(*", 
       RowBox[{
       "measured", " ", "productivity", " ", "from", " ", "cpi", " ", 
        "index"}], "*)"}], "\[IndentingNewLine]", "\t", 
      RowBox[{"shipmentsHat", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{"LMhatOut", "+", "1"}], ")"}], 
         RowBox[{"(", 
          RowBox[{"whatOut", "+", "1"}], ")"}]}], "-", "1"}]}], ";", 
      "\[IndentingNewLine]", "\t", 
      RowBox[{"countyline", "=", 
       RowBox[{"Table", "[", 
        RowBox[{"i", ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "ncounties"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\t", 
      RowBox[{"replication", "=", 
       RowBox[{"Table", "[", 
        RowBox[{"rep", ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "ncounties"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\t", 
      RowBox[{"(*", 
       RowBox[{"data", " ", "to", " ", "export"}], "*)"}], 
      "\[IndentingNewLine]", "\t", 
      RowBox[{"allData", "=", 
       RowBox[{"{", 
        RowBox[{
        "replication", ",", "countyline", ",", "whatOut", ",", "VbarhatOut", 
         ",", "realinchatOut", ",", "LMhatOut", ",", "LRhatOut", ",", 
         "QhatOut", ",", "PhatOut", ",", "pricehatOut", ",", 
         "\[Lambda]hatOut", ",", "\[Pi]nihatOut", ",", 
         RowBox[{"prodChange", "-", "1"}], ",", "measuredProdhat", ",", 
         "shipmentsHat"}], "}"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", "\t", 
      RowBox[{"Clear", "[", "out", "]"}], ";", "\[IndentingNewLine]", "\t", 
      RowBox[{"out", "=", 
       RowBox[{"Join", "[", 
        RowBox[{"varnames", ",", "allData", ",", "2"}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\t", 
      RowBox[{"out", "=", 
       RowBox[{"Transpose", "[", "out", "]"}]}], ";", "\[IndentingNewLine]", 
      "\t", 
      RowBox[{"out", "=", 
       RowBox[{"Join", "[", 
        RowBox[{"countyNames", ",", "out", ",", "2"}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", "\t", 
      "\[IndentingNewLine]", "\t", "\[IndentingNewLine]", 
      RowBox[{"Print", "[", 
       RowBox[{
       "\"\< Replication \>\"", ",", " ", "rep", ",", " ", 
        "\"\< concluded at \>\"", ",", 
        RowBox[{"DateString", "[", "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{
        "the", " ", "third", " ", "column", " ", "is", " ", "1", " ", "for", 
         " ", "treatment"}], ",", " ", 
        RowBox[{"0", " ", "for", " ", "control", " ", "outcome"}]}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"{", 
       RowBox[{"out", ",", "c", ",", "distWages", ",", "dist\[Lambda]"}], 
       "}"}]}]}], "\[IndentingNewLine]", "\[IndentingNewLine]", "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.6412088296097946`*^9, 3.6412088324320774`*^9}, {
   3.6767979864829245`*^9, 3.67679799535599*^9}, 
   3.7345395132345285`*^9},ExpressionUUID->"09ccdce0-ff2c-4ba6-a724-\
57a65fcf79d4"]
}, Closed]]
}, Closed]]
}, Closed]],

Cell[CellGroupData[{

Cell["Data Preparation", "Chapter",
 CellChangeTimes->{{3.640971746903284*^9, 3.640971747926386*^9}, {
  3.6420602456303873`*^9, 3.6420602468843875`*^9}, {3.6420603188743877`*^9, 
  3.6420603271293874`*^9}, {3.734531646576565*^9, 
  3.734531649627569*^9}},ExpressionUUID->"a5007de0-8e78-4783-af18-\
5889b335bdf9"],

Cell[CellGroupData[{

Cell["Productivities and Associated Trade Flows", "Subchapter",
 CellChangeTimes->{{3.6183055870000877`*^9, 3.6183055904700875`*^9}, {
   3.64103925091654*^9, 3.6410392535312786`*^9}, {3.6410408967442007`*^9, 
   3.641040903246245*^9}, 
   3.6410412252492156`*^9},ExpressionUUID->"a6c326b2-22cb-4be5-800a-\
828708e33972"],

Cell[CellGroupData[{

Cell["Assigning deficits ", "Section",
 CellChangeTimes->{{3.618238956471207*^9, 3.618238957751335*^9}, {
   3.6416378467382174`*^9, 3.641637849466217*^9}, {3.641839516752882*^9, 
   3.6418395237685833`*^9}, {3.6418395964988556`*^9, 3.641839604659672*^9}, 
   3.641852170600978*^9},ExpressionUUID->"9575d7c0-79e7-4fb8-a8db-\
e6a79fea5265"],

Cell["\<\
The procedure to assign the deficit and to compute residential expenditure \
here is much simplified since we import the deficits directly using \
implications of county-level calibrations. \
\>", "Text",
 CellChangeTimes->{{3.73453125642196*^9, 
  3.7345313214300604`*^9}},ExpressionUUID->"6849d774-802c-4367-b9ef-\
4a22c942ba03"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"deficit", "=", "czDeficits"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"resExpenditure", "=", 
   RowBox[{"resIncome", "+", "deficit"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Min", "[", 
  RowBox[{"resIncome", "+", "deficit"}], "]"}]}], "Input",
 CellChangeTimes->{{3.6841782943107157`*^9, 3.6841783051407394`*^9}, {
  3.6841783568423553`*^9, 3.6841783575073566`*^9}},
 CellLabel->"In[43]:=",ExpressionUUID->"731e5b26-806a-484b-9c95-dfb2b819c67b"]
}, Closed]],

Cell[CellGroupData[{

Cell["Estimating productivities and CZ-level trade flows", "Section",
 CellChangeTimes->{{3.641040980093943*^9, 3.6410409886723995`*^9}, {
  3.641041216670153*^9, 3.641041219909981*^9}, {3.6410615017912493`*^9, 
  3.6410615142154922`*^9}, {3.734533256403002*^9, 
  3.734533256503002*^9}},ExpressionUUID->"0a9d7f75-a3a7-49c8-832c-\
af12db265b98"],

Cell["Computing productivities given data", "Text",
 CellChangeTimes->{{3.7345331904789047`*^9, 
  3.7345331993169174`*^9}},ExpressionUUID->"89fa6eaa-faf2-466b-a6d4-\
7c8a04d35610"],

Cell[BoxData[
 RowBox[{
  RowBox[{"prodOnlyTrading", "=", 
   RowBox[{"productivities", "[", 
    RowBox[{
    "workplaceEmp", ",", "workplaceWage", ",", "resExpenditure", ",", 
     "distancesOnlyTrading", ",", "0"}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.6177972087769513`*^9, 3.617797233078381*^9}, {
   3.6177974243125024`*^9, 3.617797502883359*^9}, {3.6177977053916073`*^9, 
   3.617797735832651*^9}, {3.6177977804621143`*^9, 3.617797793782446*^9}, {
   3.6177978313432016`*^9, 3.617797983592425*^9}, {3.6178237474241247`*^9, 
   3.617823753913767*^9}, {3.617823858216035*^9, 3.617823901896315*^9}, {
   3.61782403518357*^9, 3.6178240386155915`*^9}, {3.617824084027483*^9, 
   3.6178240873971043`*^9}, {3.617824198703818*^9, 3.6178242810255456`*^9}, 
   3.6178244757147937`*^9, {3.6178249649339294`*^9, 3.617825011968231*^9}, 
   3.617825106660838*^9, {3.61782530975854*^9, 3.6178253550612307`*^9}, {
   3.617825488972489*^9, 3.6178255232303085`*^9}, {3.6178257362808743`*^9, 
   3.6178258983035126`*^9}, 3.6178260851459103`*^9, {3.61782621138192*^9, 
   3.6178262381516914`*^9}, {3.617826288025211*^9, 3.6178263067297306`*^9}, {
   3.617826405696765*^9, 3.617826423465279*^9}, {3.617826464665143*^9, 
   3.6178265343975897`*^9}, {3.6178265682966075`*^9, 
   3.6178265712606263`*^9}, {3.617826686826167*^9, 3.6178267212243876`*^9}, {
   3.617826905024766*^9, 3.6178269227620797`*^9}, {3.617827001292983*^9, 
   3.6178270647385893`*^9}, {3.6178274457242317`*^9, 
   3.6178275712426367`*^9}, {3.61782764035108*^9, 3.6178276733608913`*^9}, {
   3.617827726635233*^9, 3.6178278841494427`*^9}, {3.617827915677244*^9, 
   3.617827919078066*^9}, {3.617827988623312*^9, 3.6178279966729636`*^9}, {
   3.617828052443321*^9, 3.617828120319356*^9}, {3.617828182048952*^9, 
   3.617828185683775*^9}, {3.61782822388842*^9, 3.617828293480466*^9}, {
   3.617828450526673*^9, 3.6178284788408546`*^9}, {3.617828522552335*^9, 
   3.617828548479701*^9}, {3.617828686868188*^9, 3.617828697367055*^9}, {
   3.61782885407006*^9, 3.6178289476862597`*^9}, {3.6178289843464947`*^9, 
   3.617829017122305*^9}, {3.6178290596621346`*^9, 3.617829137526971*^9}, {
   3.6178291740188026`*^9, 3.6178291772469263`*^9}, {3.6178292103858767`*^9, 
   3.617829359972374*^9}, 3.6178294078698373`*^9, {3.617829560360586*^9, 
   3.6178295605205708`*^9}, {3.617871077845395*^9, 3.6178711214320745`*^9}, {
   3.6178711588567142`*^9, 3.6178711873268967`*^9}, {3.617872198899781*^9, 
   3.6178722153734865`*^9}, {3.6178722526577263`*^9, 
   3.6178723060412683`*^9}, {3.6178724953796816`*^9, 3.6178725512748404`*^9}, 
   3.6178726327229624`*^9, {3.6178727917503815`*^9, 3.617872809737297*^9}, {
   3.6178728528715734`*^9, 3.617872878065735*^9}, {3.617877553580145*^9, 
   3.6178775592117805`*^9}, {3.617880315250248*^9, 3.617880375217032*^9}, {
   3.61788043106539*^9, 3.6178804408154526`*^9}, {3.6178806754721565`*^9, 
   3.6178806762677617`*^9}, 3.617881285155265*^9, {3.6178815245543995`*^9, 
   3.6178815521353765`*^9}, {3.617881822157507*^9, 3.6178818642465773`*^9}, 
   3.617881960967197*^9, 3.6178820641462584`*^9, {3.6178821627700906`*^9, 
   3.6178822084471836`*^9}, {3.6180524178059196`*^9, 
   3.6180524443885775`*^9}, {3.6180526019123287`*^9, 
   3.6180526057207093`*^9}, {3.6180528493110657`*^9, 
   3.6180529111842527`*^9}, {3.618052946002734*^9, 3.6180529469528294`*^9}, {
   3.618053031029236*^9, 3.618053045691702*^9}, {3.6180533926953993`*^9, 
   3.618053444849614*^9}, {3.618053477026831*^9, 3.6180534794080696`*^9}, {
   3.6180536325183787`*^9, 3.6180536423243594`*^9}, {3.6180539361567397`*^9, 
   3.6180539445575795`*^9}, 3.618054093824505*^9, {3.6180542098081017`*^9, 
   3.61805421088721*^9}, {3.618054357625882*^9, 3.6180544433504543`*^9}, {
   3.6180544875988784`*^9, 3.6180544936134796`*^9}, 3.6180545946515827`*^9, {
   3.618054645081625*^9, 3.6180546470668235`*^9}, {3.6180546925703735`*^9, 
   3.618054742409357*^9}, {3.6180547806281786`*^9, 3.6180547812592416`*^9}, {
   3.618054832390354*^9, 3.618054845677683*^9}, {3.6180548816722817`*^9, 
   3.6180548895040646`*^9}, {3.6180549208401985`*^9, 3.61805492766088*^9}, {
   3.618054969433057*^9, 3.6180549700551195`*^9}, {3.6180552805081615`*^9, 
   3.618055320558166*^9}, {3.618056836927788*^9, 3.6180568377878737`*^9}, {
   3.6180568964197364`*^9, 3.6180569119802923`*^9}, {3.6180570542375164`*^9, 
   3.618057103318424*^9}, {3.618057242961387*^9, 3.6180572947725677`*^9}, {
   3.6180574082059097`*^9, 3.6180574106751566`*^9}, {3.618057552895377*^9, 
   3.6180575592880163`*^9}, {3.6180578621803026`*^9, 3.618057865492634*^9}, {
   3.618058012375321*^9, 3.618058073833466*^9}, {3.6180583746315427`*^9, 
   3.6180583802201014`*^9}, {3.6180590043044405`*^9, 
   3.6180590093414326`*^9}, {3.618059077891183*^9, 3.618059177891183*^9}, {
   3.6180656290869865`*^9, 3.618065660112088*^9}, 3.6180658919682717`*^9, {
   3.6180659960796824`*^9, 3.6180659977428484`*^9}, 3.618068358435894*^9, {
   3.6180685965947075`*^9, 3.618068599258974*^9}, {3.618068658597907*^9, 
   3.618068709181965*^9}, {3.6180687553985863`*^9, 3.6180687563126774`*^9}, {
   3.6180688382068663`*^9, 3.618068906487694*^9}, {3.618068940380082*^9, 
   3.6180689699130354`*^9}, {3.618069040850128*^9, 3.6180690887629194`*^9}, {
   3.6180692005430965`*^9, 3.6180692417102127`*^9}, {3.6180693235033913`*^9, 
   3.6180693239984407`*^9}, {3.6180695524592843`*^9, 3.618069588178856*^9}, 
   3.6180697067337103`*^9, {3.618069737763813*^9, 3.6180697542594624`*^9}, {
   3.618070284011432*^9, 3.61807029259229*^9}, {3.61807042719975*^9, 
   3.6180704560316324`*^9}, 3.61814191528716*^9, {3.6181420193665667`*^9, 
   3.618142024590089*^9}, {3.6181421374593744`*^9, 3.618142184038032*^9}, 
   3.6181423288665133`*^9, {3.618142693880011*^9, 3.6181427103766603`*^9}, {
   3.6181427544420667`*^9, 3.6181427546730895`*^9}, {3.6181540248179913`*^9, 
   3.6181540473192415`*^9}, {3.6181541653930473`*^9, 
   3.6181542200575137`*^9}, {3.6181544454340487`*^9, 
   3.6181544897444797`*^9}, {3.6182208944676356`*^9, 
   3.6182208972739162`*^9}, {3.6182504317303314`*^9, 
   3.6182504420793667`*^9}, {3.6182505172258806`*^9, 
   3.6182505191770754`*^9}, {3.618250636463803*^9, 3.6182506381079674`*^9}, 
   3.6183055095200877`*^9, {3.6410305813442807`*^9, 3.641030581857332*^9}, {
   3.641031512927247*^9, 3.641031546176572*^9}, {3.6410315882187757`*^9, 
   3.641031599337888*^9}, {3.6410316585238056`*^9, 3.641031690228976*^9}, {
   3.641032670816886*^9, 3.641032711342551*^9}, {3.6410340748623424`*^9, 
   3.6410340760363503`*^9}, {3.641034872766431*^9, 3.641034880490481*^9}, {
   3.641037680928957*^9, 3.6410376849627833`*^9}, {3.6411183893346567`*^9, 
   3.641118398462569*^9}, {3.6411184545671787`*^9, 3.641118456591381*^9}, {
   3.641118691734893*^9, 3.6411186935260725`*^9}, {3.641120135376243*^9, 
   3.6411201361283183`*^9}, {3.6411201848571906`*^9, 
   3.6411201913368387`*^9}, {3.6411202826439686`*^9, 
   3.6411202835080547`*^9}, {3.64112063069477*^9, 3.641120631053806*^9}, {
   3.641120763482047*^9, 3.641120763921091*^9}, {3.641120842027901*^9, 
   3.6411208729989977`*^9}, {3.6411209576394615`*^9, 3.641120959190616*^9}, {
   3.641122570460727*^9, 3.641122589645645*^9}, {3.6411234977604475`*^9, 
   3.641123498272499*^9}, 3.641124378130476*^9, {3.6411244207637386`*^9, 
   3.641124422513914*^9}, {3.641126386778321*^9, 3.6411264164442873`*^9}, 
   3.6412520569510965`*^9, {3.641635517220217*^9, 3.641635519626217*^9}, {
   3.642056798118387*^9, 3.6420568062423873`*^9}},
 CellLabel->"In[46]:=",ExpressionUUID->"60a0c47d-6c56-4f4a-a0f8-8ac9b5b8a77d"],

Cell["Trade flows based on those productivities", "Text",
 CellChangeTimes->{{3.6410406474310894`*^9, 
  3.641040655110857*^9}},ExpressionUUID->"026e7e0a-0e53-4c15-a087-\
663aaf48d6ae"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"{", 
    RowBox[{"\[Pi]niOnlyTrading", ",", "tradeOnlyTrading"}], "}"}], "=", 
   RowBox[{"trade", "[", 
    RowBox[{
    "prodOnlyTrading", ",", "workplaceEmp", ",", "workplaceWage", ",", 
     "resExpenditure", ",", "distancesOnlyTrading"}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.641635530945217*^9, 3.6416355331212173`*^9}, 
   3.6420568017663875`*^9, {3.7345331672508698`*^9, 3.734533183651894*^9}},
 CellLabel->"In[47]:=",ExpressionUUID->"8fd4cb4f-d560-489d-85a3-8425022c6f41"],

Cell["\<\
Testing trade shares sum to 1 by column and markets are clearing\
\>", "Text",
 CellChangeTimes->{{3.6410412384725013`*^9, 3.6410412526195946`*^9}, {
  3.641041283300195*^9, 3.6410412878282247`*^9}, {3.6412131918359737`*^9, 
  3.6412131940111914`*^9}},ExpressionUUID->"b9f97ff2-53a3-4a96-a6f7-\
7a7216685752"],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{"{", 
  RowBox[{
   RowBox[{"Min", "[", 
    RowBox[{"Total", "[", "\[Pi]niOnlyTrading", "]"}], "]"}], ",", 
   RowBox[{"Max", "[", 
    RowBox[{"Total", "[", "\[Pi]niOnlyTrading", "]"}], "]"}]}], 
  "}"}], "\[IndentingNewLine]", 
 RowBox[{"{", 
  RowBox[{
   RowBox[{"Min", "[", 
    FractionBox[
     RowBox[{"Total", "[", "tradeOnlyTrading", "]"}], "resExpenditure"], 
    "]"}], ",", 
   RowBox[{"Max", "[", 
    FractionBox[
     RowBox[{"Total", "[", "tradeOnlyTrading", "]"}], "resExpenditure"], 
    "]"}]}], "}"}], "\[IndentingNewLine]"}], "Input",
 CellChangeTimes->{{3.641041260634447*^9, 3.6410413273032813`*^9}, {
  3.6416414441072173`*^9, 3.641641451649217*^9}, {3.6420568150723877`*^9, 
  3.6420568173673873`*^9}},
 CellLabel->"In[48]:=",ExpressionUUID->"b70a2331-15ef-4720-acb7-30e146963920"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"0.9999999999999968`", ",", "1.0000000000000042`"}], 
  "}"}]], "Output",
 CellChangeTimes->{3.6410413491534224`*^9, 3.6411485022835183`*^9, 
  3.641229817500374*^9, 3.641252377316097*^9, 3.641253093900097*^9, 
  3.641638657020217*^9, 3.6418126411298656`*^9, 3.6418527728466988`*^9, 
  3.6418939120406666`*^9, 3.641922277652076*^9, 3.6420568501903877`*^9, 
  3.6421550011533422`*^9, 3.6527019729047337`*^9, 3.6527022651691628`*^9, 
  3.6529662982244873`*^9, 3.6532121860290155`*^9, 3.6538142328846846`*^9, 
  3.65424970471047*^9, 3.6544532041863213`*^9, 3.6766426546236057`*^9, 
  3.6766530217623687`*^9, 3.6766538153434796`*^9, 3.676655042298237*^9, 
  3.6769006776069717`*^9, 3.67706719137741*^9, 3.6805183496705914`*^9, 
  3.6805261096753535`*^9, 3.680526417972931*^9, 3.681669094015277*^9, 
  3.6845861640169*^9, 3.6845992646442146`*^9, 3.684675786087993*^9, 
  3.684682722313325*^9, 3.6846888460487137`*^9, 3.6857294773332667`*^9, 
  3.734533323939106*^9},
 CellLabel->"Out[48]=",ExpressionUUID->"00cc3bd1-aa25-44dc-9544-eefbfbe4ef05"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"0.9999999999999954`", ",", "1.0000000000000044`"}], 
  "}"}]], "Output",
 CellChangeTimes->{3.6410413491534224`*^9, 3.6411485022835183`*^9, 
  3.641229817500374*^9, 3.641252377316097*^9, 3.641253093900097*^9, 
  3.641638657020217*^9, 3.6418126411298656`*^9, 3.6418527728466988`*^9, 
  3.6418939120406666`*^9, 3.641922277652076*^9, 3.6420568501903877`*^9, 
  3.6421550011533422`*^9, 3.6527019729047337`*^9, 3.6527022651691628`*^9, 
  3.6529662982244873`*^9, 3.6532121860290155`*^9, 3.6538142328846846`*^9, 
  3.65424970471047*^9, 3.6544532041863213`*^9, 3.6766426546236057`*^9, 
  3.6766530217623687`*^9, 3.6766538153434796`*^9, 3.676655042298237*^9, 
  3.6769006776069717`*^9, 3.67706719137741*^9, 3.6805183496705914`*^9, 
  3.6805261096753535`*^9, 3.680526417972931*^9, 3.681669094015277*^9, 
  3.6845861640169*^9, 3.6845992646442146`*^9, 3.684675786087993*^9, 
  3.684682722313325*^9, 3.6846888460487137`*^9, 3.6857294773332667`*^9, 
  3.734533323939106*^9},
 CellLabel->"Out[49]=",ExpressionUUID->"0d54853b-bd6e-424f-9733-3806684559d7"]
}, Closed]]
}, Closed]]
}, Closed]],

Cell[CellGroupData[{

Cell["Data for reduced form regressions", "Subchapter",
 CellChangeTimes->{{3.6360523783166423`*^9, 3.6360523945172625`*^9}, {
   3.6410598266460366`*^9, 3.641059837631135*^9}, {3.6410599138247538`*^9, 
   3.641059924077779*^9}, {3.6412278754241858`*^9, 3.6412278757682204`*^9}, {
   3.678113051412741*^9, 3.6781130529927435`*^9}, 
   3.6805183196565347`*^9},ExpressionUUID->"6df7cc43-6928-4709-b0b8-\
5a18850750ae"],

Cell[CellGroupData[{

Cell["Statistics and partial derivatives", "Section",
 CellChangeTimes->{{3.642160408435342*^9, 
  3.642160414458342*^9}},ExpressionUUID->"960a2dfc-8498-4398-9e49-\
ec02dd333b2a"],

Cell["\<\
This section generates the \
\[OpenCurlyDoubleQuote]CZ_data_for_reduced_form_fullTD.csv\
\[CloseCurlyDoubleQuote] file in the data folder. This file contains partial \
derivatives for commuting, counties productivities and other statistics used \
in the stata file. \
\>", "Text",
 CellChangeTimes->{{3.7345334914633684`*^9, 
  3.734533495920375*^9}},ExpressionUUID->"b56250d6-278b-47f2-b0a2-\
f3b3014c2c49"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"workIncome", "=", 
    FractionBox[
     RowBox[{"workplaceWage", " ", "workplaceEmp"}], 
     SuperscriptBox["10", "6"]]}], ";"}], " "}]], "Input",
 CellLabel->"In[50]:=",ExpressionUUID->"0c8fe2e7-9644-4415-a9f3-e8f441c28e31"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{"Exporting", " ", "own", " ", "elasticities"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "varnames", ",", "isIn120", ",", "emplAround", ",", "weights", ",", 
       "workplaceWageAround", ",", "resAround", ",", "resWageAround", ",", 
       "out", ",", "temp1", ",", "z1", ",", "z2", ",", "z3", ",", "z4", ",", 
       "z5", " ", ",", "\[Alpha]rn", ",", "\[Mu]rn", ",", "\[Lambda]rnr"}], 
      "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"isIn120", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"distancesAllPairs", "[", 
             RowBox[{"[", 
              RowBox[{"i", ",", "j"}], "]"}], "]"}], "\[LessEqual]", "120"}], 
           ",", "1", ",", "0"}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "ncounties"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"j", ",", "1", ",", "ncounties"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"isIn120", "[", 
          RowBox[{"[", 
           RowBox[{"i", ",", "i"}], "]"}], "]"}], "=", "0"}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", "1", ",", "ncounties"}], "}"}]}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"emplAround", "=", 
       RowBox[{"isIn120", ".", "workplaceEmp"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"weights", "=", 
       RowBox[{
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"isIn120", "[", 
            RowBox[{"[", 
             RowBox[{"i", ",", "j"}], "]"}], "]"}], 
           FractionBox[
            RowBox[{"workplaceEmp", "[", 
             RowBox[{"[", "j", "]"}], "]"}], 
            RowBox[{
             RowBox[{"emplAround", "[", 
              RowBox[{"[", "i", "]"}], "]"}], "+", 
             RowBox[{"isIn120", "[", 
              RowBox[{"[", 
               RowBox[{"i", ",", "j"}], "]"}], "]"}], "-", "1"}]]}], ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", "1", ",", "ncounties"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"j", ",", "1", ",", "ncounties"}], "}"}]}], "]"}], " ", 
        "isIn120"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"workplaceWageAround", "=", 
       RowBox[{"weights", ".", "workplaceWage"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"resAround", "=", 
       RowBox[{"isIn120", ".", "resEmp"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"weights", "=", 
       RowBox[{
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"isIn120", "[", 
            RowBox[{"[", 
             RowBox[{"i", ",", "j"}], "]"}], "]"}], 
           FractionBox[
            RowBox[{"resEmp", "[", 
             RowBox[{"[", "j", "]"}], "]"}], 
            RowBox[{
             RowBox[{"resAround", "[", 
              RowBox[{"[", "i", "]"}], "]"}], "+", 
             RowBox[{"isIn120", "[", 
              RowBox[{"[", 
               RowBox[{"i", ",", "j"}], "]"}], "]"}], "-", "1"}]]}], ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", "1", ",", "ncounties"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"j", ",", "1", ",", "ncounties"}], "}"}]}], "]"}], " ", 
        "isIn120"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"resWageAround", "=", 
       RowBox[{"weights", ".", "resWage"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"\[Alpha]rn", "=", 
       RowBox[{"Transpose", "[", 
        RowBox[{
         RowBox[{"Transpose", "[", 
          FractionBox["\[Pi]niOnlyTrading", "laborIncome"], "]"}], 
         RowBox[{"(", 
          RowBox[{"resIncome", "+", "deficit"}], ")"}]}], "]"}]}], ";", " ", 
      "\[IndentingNewLine]", 
      RowBox[{"Print", "[", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"Min", "[", 
          RowBox[{"Total", "[", 
           RowBox[{"\[Alpha]rn", ",", 
            RowBox[{"{", "2", "}"}]}], "]"}], "]"}], ",", 
         RowBox[{"Max", "[", 
          RowBox[{"Total", "[", 
           RowBox[{"\[Alpha]rn", ",", 
            RowBox[{"{", "2", "}"}]}], "]"}], "]"}]}], "}"}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"\[Mu]rn", "=", 
       RowBox[{"1.", " ", 
        RowBox[{"Transpose", "[", 
         FractionBox[
          RowBox[{"Transpose", "[", "\[Lambda]", "]"}], "workplaceEmp"], 
         "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"\[Lambda]rnr", "=", 
       RowBox[{"1.0", " ", 
        FractionBox["\[Lambda]", "resEmp"]}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"z1", "=", 
       RowBox[{"Total", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{"1", "-", "\[Lambda]rnr"}], ")"}], " ", "\[Mu]rn"}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"z2", "=", 
       RowBox[{
        RowBox[{"Diagonal", "[", "\[Mu]rn", "]"}], 
        RowBox[{"(", 
         RowBox[{
          FractionBox[
           RowBox[{"Diagonal", "[", "\[Lambda]", "]"}], "resEmp"], "-", 
          FractionBox["workplaceEmp", 
           RowBox[{"Total", "[", "workplaceEmp", "]"}]]}], ")"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"z3", "=", 
       RowBox[{"Total", "[", 
        RowBox[{
         RowBox[{"\[Alpha]rn", " ", 
          RowBox[{"(", 
           RowBox[{"1", "-", "\[Pi]niOnlyTrading"}], ")"}]}], ",", 
         RowBox[{"{", "2", "}"}]}], "]"}]}], ";", " ", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"for", " ", "a", " ", "fixed", " ", "row", " ", 
         RowBox[{"producer", "/", "seller"}], " ", "n"}], ",", " ", 
        RowBox[{
        "sum", " ", "across", " ", "all", " ", "residences", " ", "buying", 
         " ", "from", " ", "it"}]}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"z4", "=", 
       RowBox[{"z1", " ", "z3"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"z5", "=", 
       RowBox[{"z2", " ", "z3"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"varnames", "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", "\"\<workplaceemp\>\"", "}"}], ",", 
         RowBox[{"{", "\"\<resemp\>\"", "}"}], ",", 
         RowBox[{"{", "\"\<workplacewage\>\"", "}"}], ",", 
         RowBox[{"{", "\"\<resWage\>\"", "}"}], ",", 
         RowBox[{"{", "\"\<emplAround\>\"", "}"}], ",", 
         RowBox[{"{", "\"\<workplaceWageAround\>\"", "}"}], ",", 
         RowBox[{"{", "\"\<resAround\>\"", "}"}], ",", 
         RowBox[{"{", "\"\<resWageAround\>\"", "}"}], ",", 
         RowBox[{"{", "\"\<landArea\>\"", "}"}], ",", 
         RowBox[{"{", "\"\<lambda_nn_n\>\"", "}"}], ",", 
         RowBox[{"{", "\"\<pd_commuting\>\"", "}"}], ",", 
         RowBox[{"{", "\"\<pd_migration\>\"", "}"}], ",", 
         RowBox[{"{", "\"\<pd_goods\>\"", "}"}], ",", 
         RowBox[{"{", "\"\<pd_commuting_goods\>\"", "}"}], ",", 
         RowBox[{"{", "\"\<pd_migration_goods\>\"", "}"}], ",", 
         RowBox[{"{", "\"\<productivity\>\"", "}"}], ",", 
         RowBox[{"{", "\"\<deficit\>\"", "}"}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"out", "=", 
       RowBox[{"Join", "[", 
        RowBox[{"varnames", ",", 
         RowBox[{"{", 
          RowBox[{
          "workplaceEmp", ",", "resEmp", ",", "workplaceWage", ",", "resWage",
            ",", "emplAround", ",", "workplaceWageAround", ",", "resAround", 
           ",", "resWageAround", ",", "landArea", ",", 
           RowBox[{"Diagonal", "[", "\[Lambda]rnr", "]"}], ",", "z1", ",", 
           "z2", ",", "z3", ",", "z4", ",", "z5", ",", "prodOnlyTrading", ",",
            "deficit"}], "}"}], ",", "2"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"out", "=", 
       RowBox[{"Transpose", "[", "out", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"out", "=", 
       RowBox[{"Join", "[", 
        RowBox[{"countyNames", ",", "out", ",", "2"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Export", "[", 
       RowBox[{
       "\"\<data\\\\CZ_data_for_reduced_form_fullTD.csv\>\"", ",", " ", 
        "out"}], "]"}]}]}], " ", "\[IndentingNewLine]", "]"}], 
   ";"}]}]], "Input",
 CellChangeTimes->{{3.636052470881898*^9, 3.636052518915701*^9}, {
   3.6360525591847277`*^9, 3.6360525928850975`*^9}, {3.6360526508708954`*^9, 
   3.6360527104408517`*^9}, {3.6360527742582326`*^9, 
   3.6360528400998163`*^9}, {3.6360529207018757`*^9, 
   3.6360529955373583`*^9}, {3.6360533846762686`*^9, 3.636053451957996*^9}, 
   3.636111319472726*^9, {3.6361121047363176`*^9, 3.6361121389296055`*^9}, {
   3.6361125716988926`*^9, 3.636112699969039*^9}, {3.636112984923641*^9, 
   3.636112996535919*^9}, 3.636113089237356*^9, {3.636113208476403*^9, 
   3.6361132351039853`*^9}, {3.636113944997055*^9, 3.6361141341474066`*^9}, {
   3.6361141759325843`*^9, 3.636114298720862*^9}, {3.6361151070629873`*^9, 
   3.6361151912624063`*^9}, {3.636115318198099*^9, 3.6361153230785866`*^9}, {
   3.6361161760234423`*^9, 3.636116176589046*^9}, {3.636116207463111*^9, 
   3.6361162263320494`*^9}, {3.636116273061386*^9, 3.6361163117175426`*^9}, {
   3.6361163629028144`*^9, 3.636116400848959*^9}, {3.636116461160289*^9, 
   3.6361164926519265`*^9}, {3.636116534478627*^9, 3.6361166056959887`*^9}, {
   3.6361166372646346`*^9, 3.636116638461243*^9}, {3.6361272931927805`*^9, 
   3.636127304675929*^9}, {3.636127868605316*^9, 3.6361278692983856`*^9}, 
   3.636127941436599*^9, {3.63612819197365*^9, 3.6361282116926217`*^9}, {
   3.636128547629212*^9, 3.6361286778282814`*^9}, {3.636129184949794*^9, 
   3.6361292073820367`*^9}, {3.6361292770250006`*^9, 3.636129300049303*^9}, {
   3.6361293329545927`*^9, 3.636129348866184*^9}, {3.6361293963824825`*^9, 
   3.6361295692151213`*^9}, {3.636131854289301*^9, 3.6361318678336554`*^9}, {
   3.6361322258774557`*^9, 3.636132232558124*^9}, {3.636132274277295*^9, 
   3.6361323185607233`*^9}, {3.6361323549873657`*^9, 
   3.6361323951423807`*^9}, {3.636132471510017*^9, 3.6361324753894043`*^9}, {
   3.636132507798645*^9, 3.6361326725411177`*^9}, {3.6361328232751894`*^9, 
   3.6361328886757293`*^9}, {3.636132918723734*^9, 3.636132931622023*^9}, {
   3.6361330194008007`*^9, 3.636133025450405*^9}, {3.6361331215840178`*^9, 
   3.6361331271125703`*^9}, {3.636735597532342*^9, 3.6367356198005686`*^9}, {
   3.636735657410329*^9, 3.636735739109498*^9}, {3.6367377960122232`*^9, 
   3.6367378059855547`*^9}, {3.6374961672175946`*^9, 
   3.6374961755534277`*^9}, {3.63749620757263*^9, 3.637496339447816*^9}, {
   3.637498283664218*^9, 3.6374982919780493`*^9}, {3.6374983383146825`*^9, 
   3.6374984756284122`*^9}, {3.637506662360074*^9, 3.6375066883936777`*^9}, {
   3.637577404720339*^9, 3.6375774091127777`*^9}, {3.638028540812004*^9, 
   3.638028569056426*^9}, {3.6380291791464877`*^9, 3.6380291805428977`*^9}, {
   3.64122792526817*^9, 3.641227962153858*^9}, 3.6412280095135937`*^9, {
   3.641228094140055*^9, 3.6412281112617674`*^9}, {3.641230577675384*^9, 
   3.6412306081244287`*^9}, {3.641231304389048*^9, 3.6412313410557146`*^9}, {
   3.6412313998455925`*^9, 3.64123143711932*^9}, {3.6412314985354605`*^9, 
   3.6412315105536623`*^9}, 3.641231643780984*^9, {3.6415566479759645`*^9, 
   3.6415566494189644`*^9}, 3.641556686230964*^9, {3.6418939036946135`*^9, 
   3.641893908187442*^9}, {3.6418943108416233`*^9, 3.6418943812292747`*^9}, {
   3.6421515803530817`*^9, 3.642151606753721*^9}, {3.642151647867832*^9, 
   3.642151660635109*^9}, {3.65270270837582*^9, 3.652702708995821*^9}, {
   3.68468298581404*^9, 3.6846829867540417`*^9}, {3.7345336023035364`*^9, 
   3.734533623237568*^9}},ExpressionUUID->"dc08f1b7-682b-4c4e-868f-\
ae0bcdbfedb6"]
}, Closed]]
}, Closed]]
}, Closed]],

Cell[CellGroupData[{

Cell["Counterfactual Simulations", "Chapter",
 CellChangeTimes->{{3.7345316614315906`*^9, 
  3.7345316680816*^9}},ExpressionUUID->"61c38d70-7709-447b-959c-3274594ca09a"],

Cell[CellGroupData[{

Cell["a) 5% shock to each commuting zone", "Subchapter",
 CellChangeTimes->{{3.6411478584431477`*^9, 3.64114788309711*^9}, {
  3.7341797324392767`*^9, 3.7341797370612845`*^9}, {3.7345328558394027`*^9, 
  3.7345328610274105`*^9}, {3.73453416337939*^9, 3.734534169072398*^9}, {
  3.734590920548875*^9, 
  3.734590923499729*^9}},ExpressionUUID->"edc6d5c6-add2-4bb1-9b5c-\
a1c35b8839eb"],

Cell["Set up of the simulations:", "Text",
 CellChangeTimes->{{3.623514213151874*^9, 3.623514218088924*^9}, {
  3.6243012660502205`*^9, 
  3.624301271932458*^9}},ExpressionUUID->"e4095427-793d-4c2e-baae-\
05eb2a756273"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{"tolerance", ",", " ", 
    RowBox[{"max", " ", "number", " ", "of", " ", "iterations"}], ",", " ", 
    RowBox[{"speed", " ", "of", " ", "adjustment"}]}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"tol", "=", 
     SuperscriptBox["10", 
      RowBox[{"-", "6"}]]}], ";", " ", 
    RowBox[{"maxiter", "=", "1000"}], ";", " ", 
    RowBox[{"\[Zeta]", "=", "0.7"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"varnames", "=", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", "\"\<Repetition\>\"", "}"}], ",", 
       RowBox[{"{", "\"\<CountyLine\>\"", "}"}], ",", 
       RowBox[{"{", "\"\<WHat\>\"", "}"}], ",", 
       RowBox[{"{", "\"\<VbarHat\>\"", "}"}], ",", 
       RowBox[{"{", "\"\<RealIncHat\>\"", "}"}], ",", 
       RowBox[{"{", "\"\<LMhat\>\"", "}"}], ",", 
       RowBox[{"{", "\"\<LRhat\>\"", "}"}], ",", 
       RowBox[{"{", "\"\<QHat\>\"", "}"}], ",", 
       RowBox[{"{", "\"\<PHat\>\"", "}"}], ",", 
       RowBox[{"{", "\"\<PriceHat\>\"", "}"}], ",", 
       RowBox[{"{", "\"\<LambdaNNHat\>\"", "}"}], ",", 
       RowBox[{"{", "\"\<PiNNHat\>\"", "}"}], ",", 
       RowBox[{"{", "\"\<Ahat\>\"", "}"}], ",", 
       RowBox[{"{", "\"\<MeasuredProdHat\>\"", "}"}], ",", 
       RowBox[{"{", "\"\<ShipmentsHat\>\"", "}"}]}], "}"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"setting", " ", "number", " ", "of", " ", 
     RowBox[{"replications", ":", " ", 
      RowBox[{
      "one", " ", "shock", " ", "per", " ", "commuting", " ", "zone"}]}]}], 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"numberOfReplications", "=", "ncounties"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"complete", " ", "matrix", " ", "of", " ", 
     RowBox[{"shocks", ":", " ", 
      RowBox[{
      "row", " ", "number", " ", "N", " ", "has", " ", "the", " ", "shock", 
       " ", "profile", " ", "for", " ", "repetition", " ", "N"}]}]}], "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"prodShocks", "=", 
     RowBox[{"1", "+", 
      RowBox[{"DiagonalMatrix", "[", 
       RowBox[{"Table", "[", 
        RowBox[{"0.05", ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "numberOfReplications"}], "}"}]}], 
        "]"}], "]"}]}]}], ";"}], " ", "\[IndentingNewLine]"}]}]], "Input",
 CellChangeTimes->{{3.6235142279090242`*^9, 3.623514270250452*^9}, {
   3.6235144939377117`*^9, 3.623514521599989*^9}, {3.623521495295616*^9, 
   3.6235214959556227`*^9}, {3.623522678246557*^9, 3.6235227245710225`*^9}, {
   3.623522795089731*^9, 3.623522798495072*^9}, {3.6235228781300344`*^9, 
   3.6235228858188033`*^9}, {3.6235234819527054`*^9, 
   3.6235234947748337`*^9}, {3.623523570832595*^9, 3.6235235883727703`*^9}, {
   3.623534740185605*^9, 3.6235347420807943`*^9}, {3.623534925370121*^9, 
   3.6235349340259867`*^9}, {3.623535209225504*^9, 3.623535219027484*^9}, {
   3.623535255910172*^9, 3.6235352573663177`*^9}, {3.623535458931472*^9, 
   3.623535461024681*^9}, 3.6235358279077873`*^9, {3.623535874324253*^9, 
   3.623535874704257*^9}, {3.6235361428283052`*^9, 3.6235361533604126`*^9}, {
   3.623538576014176*^9, 3.623538576640239*^9}, 3.6235801268862333`*^9, {
   3.6235825766410437`*^9, 3.6235825779910574`*^9}, {3.6235829628293858`*^9, 
   3.6235829654026427`*^9}, {3.6235835964510045`*^9, 3.623583596954011*^9}, 
   3.623710728736875*^9, {3.623713332030875*^9, 3.623713337150875*^9}, {
   3.6243012883109646`*^9, 3.6243012892001705`*^9}, {3.6243019606663904`*^9, 
   3.6243019713064547`*^9}, {3.624303022659017*^9, 3.624303025638636*^9}, {
   3.6243036472239857`*^9, 3.6243036524188185`*^9}, {3.6243049548410263`*^9, 
   3.62430496378592*^9}, {3.6411479927758574`*^9, 3.6411479970034847`*^9}, {
   3.641209147539585*^9, 3.6412091572515554`*^9}, {3.641209864024226*^9, 
   3.6412098645352774`*^9}, {3.64158963745669*^9, 3.641589642950239*^9}, 
   3.6526978085839643`*^9, {3.6846888847968564`*^9, 3.6846888851568565`*^9}, {
   3.6846893208570633`*^9, 3.6846893256060715`*^9}, {3.684689362515139*^9, 
   3.684689382424175*^9}, {3.7345336477036037`*^9, 3.734533674444646*^9}, {
   3.7345337344267373`*^9, 3.7345337650897827`*^9}, {3.734533832402886*^9, 
   3.7345338327428865`*^9}, {3.7345341000992956`*^9, 
   3.7345341177983217`*^9}, {3.734534233141494*^9, 
   3.7345342376895022`*^9}},ExpressionUUID->"c5cd538c-a451-4aad-a531-\
08e0fb9b07b6"],

Cell["Computing outcomes", "Text",
 CellChangeTimes->{{3.623520025594915*^9, 
  3.6235200288102365`*^9}},ExpressionUUID->"cf848e20-8052-45ba-93c9-\
a109d948e671"],

Cell[BoxData[
 RowBox[{
  RowBox[{"out2", "=", 
   RowBox[{"Parallelize", "[", "\[IndentingNewLine]", 
    RowBox[{"Table", "[", 
     RowBox[{
      RowBox[{"countyProdShock", "[", 
       RowBox[{"rep", ",", 
        RowBox[{"prodShocks", "[", 
         RowBox[{"[", "rep", "]"}], "]"}], ",", "\[Eta]zero"}], "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"rep", ",", "1", ",", "numberOfReplications"}], "}"}]}], "]"}],
     "\[IndentingNewLine]", "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.623516079626979*^9, 3.623516217545359*^9}, {
   3.623516449977686*^9, 3.623516461239957*^9}, 3.6235166335601873`*^9, {
   3.623518332919551*^9, 3.623518335165776*^9}, {3.6235184520764656`*^9, 
   3.6235185467549324`*^9}, {3.6235186413072433`*^9, 3.623518641637246*^9}, {
   3.6235193798406363`*^9, 3.6235194199130373`*^9}, {3.6235194550253887`*^9, 
   3.623519455255391*^9}, {3.6235195900827413`*^9, 3.6235195985028257`*^9}, {
   3.6235196430862713`*^9, 3.6235197935627785`*^9}, {3.6235198523983674`*^9, 
   3.623519934843194*^9}, {3.623519979451301*^9, 3.623520017636119*^9}, 
   3.623520075298885*^9, 3.6235201590072546`*^9, {3.6235341187481384`*^9, 
   3.6235341200091515`*^9}, {3.6235386037689514`*^9, 
   3.6235386321227865`*^9}, {3.623582371780312*^9, 3.6235823754356775`*^9}, {
   3.6235825620998983`*^9, 3.623582568860966*^9}, {3.623710102003875*^9, 
   3.623710106073875*^9}, 3.623712898013875*^9, {3.6237135282998753`*^9, 
   3.623713536210875*^9}, {3.623714018860875*^9, 3.623714045282875*^9}, {
   3.623714681569875*^9, 3.6237146937678747`*^9}, {3.6243021205247617`*^9, 
   3.6243021618202267`*^9}, {3.6251415503154964`*^9, 
   3.6251415522655087`*^9}, {3.6252520368454576`*^9, 3.6252520802868013`*^9}, 
   3.6267242734801636`*^9, {3.6412087197758126`*^9, 3.641208771136948*^9}, 
   3.6412091618920197`*^9, {3.652715284768613*^9, 3.652715306523857*^9}, {
   3.6527171719835553`*^9, 3.652717173150622*^9}, {3.684689313989053*^9, 
   3.6846893175950584`*^9}, {3.7345336583866224`*^9, 3.734533661456627*^9}},
 CellLabel->"In[65]:=",ExpressionUUID->"1dd083bf-7d4a-44ba-9a04-384ac2d41267"],

Cell["Exporting data in separate files", "Text",
 CellChangeTimes->{{3.641209213788209*^9, 
  3.6412092217800083`*^9}},ExpressionUUID->"ff305875-d751-471d-bcce-\
616e65d4d531"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"Print", "[", 
   RowBox[{"\"\<Started on \>\"", ",", 
    RowBox[{"DateString", "[", "]"}]}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Table", "[", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"repN", ",", "filename"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"repN", "=", 
        RowBox[{"ToString", "[", "rep", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"rep", "<", "10"}], ",", 
         RowBox[{"repN", "=", 
          RowBox[{"\"\<000\>\"", "<>", "repN"}]}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"rep", "\[GreaterEqual]", "10"}], " ", "&&", " ", 
          RowBox[{"rep", "\[LessEqual]", "99"}]}], ",", 
         RowBox[{"repN", "=", 
          RowBox[{"\"\<00\>\"", "<>", "repN"}]}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"rep", "\[GreaterEqual]", "100"}], " ", "&&", " ", 
          RowBox[{"rep", "\[LessEqual]", "999"}]}], ",", 
         RowBox[{"repN", "=", 
          RowBox[{"\"\<0\>\"", "<>", "repN"}]}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"filename", "=", 
        RowBox[{
        "\"\<data\\\\CZ calibration shocks \
5pct\\\\county_oneShock5pct_rep\>\"", "<>", "repN", "<>", "\"\<.csv\>\""}]}], 
       ";", "\[IndentingNewLine]", 
       RowBox[{"Export", "[", 
        RowBox[{"filename", ",", " ", 
         RowBox[{"out2", "[", 
          RowBox[{"[", 
           RowBox[{"rep", ",", "1"}], "]"}], "]"}]}], "]"}], ";"}]}], 
     "\[IndentingNewLine]", "]"}], ",", "\[IndentingNewLine]", 
    RowBox[{"{", 
     RowBox[{"rep", ",", "1", ",", "numberOfReplications"}], "}"}]}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Print", "[", 
   RowBox[{"\"\<All export done on \>\"", ",", 
    RowBox[{"DateString", "[", "]"}]}], "]"}], ";"}]}], "Input",
 CellChangeTimes->{{3.624132143367365*^9, 3.624132150917765*^9}, {
   3.624132376765565*^9, 3.624132396961565*^9}, {3.6241325854435654`*^9, 
   3.624132645104565*^9}, {3.6241326826801653`*^9, 3.624132703523765*^9}, 
   3.6241327349751654`*^9, {3.6241328228621655`*^9, 3.624132829365165*^9}, {
   3.624302331989519*^9, 3.6243023327383237`*^9}, {3.624302417388153*^9, 
   3.624302426250039*^9}, {3.624304792016388*^9, 3.624304872686841*^9}, {
   3.624964060704933*^9, 3.624964071481011*^9}, {3.6251412834577837`*^9, 
   3.6251412847681923`*^9}, 3.625252108065579*^9, {3.626724278472172*^9, 
   3.6267242800789747`*^9}, {3.626838697345999*^9, 3.626838698683132*^9}, {
   3.641148087247238*^9, 3.6411481238959026`*^9}, {3.6415898317171144`*^9, 
   3.6415898329602385`*^9}, {3.641853232806428*^9, 3.6418532382149687`*^9}, {
   3.6527070797303114`*^9, 3.652707097432324*^9}, {3.6527171683193455`*^9, 
   3.6527171685833607`*^9}, {3.652720414684027*^9, 3.6527204197943196`*^9}, {
   3.652722310534464*^9, 3.6527223116305265`*^9}, {3.6529660594221306`*^9, 
   3.652966061882134*^9}, {3.6532122054660454`*^9, 3.653212205776046*^9}, {
   3.6846889120789537`*^9, 3.6846889244679804`*^9}, 3.7345337757887983`*^9},
 CellLabel->"In[66]:=",ExpressionUUID->"400d1266-3584-42d8-9ca6-6a039e725cfa"],

Cell[TextData[{
 "Checking that all converged: max number of iteration is smaller than 2000, \
and distances from previous iteration smaller than ",
 Cell[BoxData[
  FormBox[
   SuperscriptBox["10", 
    RowBox[{"-", "6"}]], TraditionalForm]],ExpressionUUID->
  "7175892a-9be4-4a17-9c27-d3280e131c08"]
}], "Text",
 CellChangeTimes->{{3.6243679326271677`*^9, 3.6243679391636095`*^9}, {
   3.624368283933448*^9, 3.6243683087556086`*^9}, {3.624968934306712*^9, 
   3.624968939795261*^9}, 
   3.641209264085238*^9},ExpressionUUID->"1c436503-dbfd-4a56-ad57-\
e3b08bce9d3a"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"Max", "[", 
    RowBox[{"Table", "[", 
     RowBox[{
      RowBox[{"out2", "[", 
       RowBox[{"[", 
        RowBox[{"i", ",", "2"}], "]"}], "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"i", ",", "1", ",", "numberOfReplications"}], "}"}]}], "]"}], 
    "]"}], ",", 
   RowBox[{"Max", "[", 
    RowBox[{"Table", "[", 
     RowBox[{
      RowBox[{"out2", "[", 
       RowBox[{"[", 
        RowBox[{"i", ",", "3"}], "]"}], "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"i", ",", "1", ",", "numberOfReplications"}], "}"}]}], "]"}], 
    "]"}], ",", 
   RowBox[{"Max", "[", 
    RowBox[{"Table", "[", 
     RowBox[{
      RowBox[{"out2", "[", 
       RowBox[{"[", 
        RowBox[{"i", ",", "4"}], "]"}], "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"i", ",", "1", ",", "numberOfReplications"}], "}"}]}], "]"}], 
    "]"}]}], "}"}]], "Input",
 CellChangeTimes->{{3.624367941659625*^9, 3.624368011094079*^9}, {
  3.6243682388871555`*^9, 3.624368276046995*^9}},
 CellLabel->"In[69]:=",ExpressionUUID->"5cc87d68-da31-4310-8159-65152a6f0a49"]
}, Closed]],

Cell[CellGroupData[{

Cell["b) Reducing commuting costs using HRI changes 1990-2007", "Subchapter",
 CellChangeTimes->{{3.6410618491529827`*^9, 3.641061860663133*^9}, {
   3.681668730838708*^9, 3.681668736830716*^9}, {3.6816687928158035`*^9, 
   3.6816688103088293`*^9}, {3.681670937879146*^9, 3.6816709441601644`*^9}, {
   3.6817286400835266`*^9, 3.6817286570525646`*^9}, {3.6817297175899677`*^9, 
   3.6817297243829813`*^9}, {3.7345341370983515`*^9, 
   3.7345341380383525`*^9}, {3.73453417600941*^9, 3.734534179083414*^9}, 
   3.734590669271144*^9},ExpressionUUID->"0f790108-3498-46b3-8b30-\
c3f412729a60"],

Cell[CellGroupData[{

Cell["Reduction by the median change", "Section",
 CellChangeTimes->{{3.6817297006459208`*^9, 3.681729711935948*^9}, {
   3.734179678133189*^9, 3.7341796832221985`*^9}, 
   3.7345341316703424`*^9},ExpressionUUID->"1e86a760-7859-4add-9ed9-\
2b645a99f1cc"],

Cell["\<\
We reduce commuting costs symmetrically for all counties. The reduction is \
the inverse of the median change in the HRI from 1990 to 2007. In this \
distribution, we only count counties with a positive HRI, and exclude \
residence=workplace cases (where HRI_hat=1). \
\>", "Text",
 CellChangeTimes->{{3.681669078631254*^9, 3.6816691769254074`*^9}, 
   3.681669762506525*^9, {3.6817285982934265`*^9, 
   3.6817286360375156`*^9}},ExpressionUUID->"497a57dc-5e2a-4837-80e1-\
a023ff2310db"],

Cell[BoxData[
 RowBox[{"\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"tolerance", ",", " ", 
    RowBox[{"max", " ", "number", " ", "of", " ", "iterations"}], ",", " ", 
    RowBox[{"speed", " ", "of", " ", "adjustment"}]}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"tol", "=", 
     SuperscriptBox["10", 
      RowBox[{"-", "6"}]]}], ";", " ", 
    RowBox[{"maxiter", "=", "1000"}], ";", " ", 
    RowBox[{"\[Zeta]", "=", "0.7"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"change", " ", "in", " ", "commuting", " ", "costs"}], "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"comch", "=", 
     SuperscriptBox[".6601334", 
      RowBox[{"1", "/", "3.3035"}]]}], " ", ";"}], " ", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
     "using", " ", "same", " ", "reduction", " ", "in", " ", "commuting", " ",
       "costs", " ", "as", " ", "in", " ", "the", " ", "county"}], "-", 
     RowBox[{"level", " ", "counterfactuals"}]}], "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"khat", "=", 
     RowBox[{"Table", "[", 
      RowBox[{"comch", ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", "1", ",", "ncounties"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"j", ",", "1", ",", "ncounties"}], "}"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Table", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"khat", "[", 
        RowBox[{"[", 
         RowBox[{"i", ",", "i"}], "]"}], "]"}], "=", "1"}], ",", 
      RowBox[{"{", 
       RowBox[{"i", ",", "1", ",", "ncounties"}], "}"}]}], "]"}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"dhat", "=", 
     RowBox[{"Table", "[", 
      RowBox[{"1", ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", "1", ",", "ncounties"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"j", ",", "1", ",", "ncounties"}], "}"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"ahat", "=", 
     RowBox[{"Table", "[", 
      RowBox[{"1", ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", "1", ",", "ncounties"}], "}"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"bhat", "=", 
     RowBox[{"Table", "[", 
      RowBox[{"1", ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", "1", ",", "ncounties"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"j", ",", "1", ",", "ncounties"}], "}"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"elast", "=", 
     RowBox[{"Table", "[", 
      RowBox[{"0", ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", "1", ",", "ncounties"}], "}"}]}], "]"}]}], 
    ";"}]}]}]], "Input",
 CellChangeTimes->{{3.641140521292776*^9, 3.641140541180765*^9}, {
   3.641253201747097*^9, 3.641253203669097*^9}, {3.6413205512543764`*^9, 
   3.6413205839186425`*^9}, {3.641320662952545*^9, 3.6413206635286026`*^9}, {
   3.6419223039527063`*^9, 3.64192230909622*^9}, 3.641944156052787*^9, 
   3.641944425288693*^9, {3.641945157157748*^9, 3.6419452233192034`*^9}, {
   3.64199378495715*^9, 3.6419938011647706`*^9}, 3.6526979704742146`*^9, {
   3.6542574106878295`*^9, 3.654257415160836*^9}, {3.6542586824522486`*^9, 
   3.6542586894642615`*^9}, {3.6816692084494567`*^9, 3.681669261006547*^9}, {
   3.6816693135976353`*^9, 3.6816693670427303`*^9}, {3.681728584288392*^9, 
   3.6817285856033955`*^9}, {3.6817287343747606`*^9, 
   3.6817287644409423`*^9}, {3.6817288325283422`*^9, 
   3.6817288441273656`*^9}, {3.6818277933394227`*^9, 
   3.6818277958244295`*^9}, {3.685729530394376*^9, 3.6857295531284137`*^9}},
 CellLabel->"In[70]:=",ExpressionUUID->"bf08d7f8-fce8-44a5-90a5-6016b7ee018b"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"khat", "[", 
   RowBox[{"[", 
    RowBox[{
     RowBox[{"1", ";;", "4"}], ",", 
     RowBox[{"1", ";;", "4"}]}], "]"}], "]"}], "//", "MatrixForm"}]], "Input",
 CellChangeTimes->{{3.6816693792957544`*^9, 3.681669380237756*^9}, {
   3.681669767026533*^9, 3.6816697811905613`*^9}, 3.6816698395011144`*^9, {
   3.681669903738945*^9, 3.6816699093049555`*^9}, {3.6816704510218782`*^9, 
   3.681670474113925*^9}, {3.6817287078116913`*^9, 3.6817287191887236`*^9}},
 CellLabel->"In[78]:=",ExpressionUUID->"80a283fe-7002-40f1-9943-728f7bb2aa4e"],

Cell[BoxData[
 TagBox[
  RowBox[{"(", "\[NoBreak]", GridBox[{
     {"1", "0.881862448076073`", "0.881862448076073`", "0.881862448076073`"},
     {"0.881862448076073`", "1", "0.881862448076073`", "0.881862448076073`"},
     {"0.881862448076073`", "0.881862448076073`", "1", "0.881862448076073`"},
     {"0.881862448076073`", "0.881862448076073`", "0.881862448076073`", "1"}
    },
    GridBoxAlignment->{
     "Columns" -> {{Center}}, "ColumnsIndexed" -> {}, "Rows" -> {{Baseline}}, 
      "RowsIndexed" -> {}},
    GridBoxSpacings->{"Columns" -> {
        Offset[0.27999999999999997`], {
         Offset[0.7]}, 
        Offset[0.27999999999999997`]}, "ColumnsIndexed" -> {}, "Rows" -> {
        Offset[0.2], {
         Offset[0.4]}, 
        Offset[0.2]}, "RowsIndexed" -> {}}], "\[NoBreak]", ")"}],
  Function[BoxForm`e$, 
   MatrixForm[BoxForm`e$]]]], "Output",
 CellChangeTimes->{3.681669381309757*^9, 3.681669781820562*^9, 
  3.6816698413691177`*^9, 3.681669910494961*^9, 3.681670474683926*^9, 
  3.6817287200797253`*^9, 3.6817288191241703`*^9, 3.6818278523365307`*^9, 
  3.7345343195426292`*^9},
 CellLabel->
  "Out[78]//MatrixForm=",ExpressionUUID->"51aaa20b-204c-4760-ac96-\
257f99c77831"]
}, Closed]],

Cell[BoxData[""], "Input",
 CellChangeTimes->{{3.6419444169210386`*^9, 
  3.641944422511875*^9}},ExpressionUUID->"63303168-3590-441f-8e20-\
0886ac3033fb"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"comm", "=", 
    RowBox[{"hatChanges", "[", 
     RowBox[{
     "khat", ",", "dhat", ",", "ahat", ",", "bhat", ",", "\[Eta]zero", ",", 
      "25"}], "]"}]}], ";"}], "\[IndentingNewLine]"}]], "Input",
 CellChangeTimes->{
  3.641140519915639*^9, {3.641140558789526*^9, 3.64114070294694*^9}, {
   3.6411407460272474`*^9, 3.6411407647561207`*^9}, {3.641253125092097*^9, 
   3.641253129570097*^9}, {3.6413206677060204`*^9, 3.6413206724964995`*^9}, {
   3.68172880839915*^9, 3.6817288100051546`*^9}, {3.6817288542793856`*^9, 
   3.681728854709387*^9}, {3.7345342891965814`*^9, 3.7345342914885864`*^9}},
 CellLabel->"In[79]:=",ExpressionUUID->"d6b27608-8c69-4cbc-87a8-a04e2b76349e"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"{", 
    RowBox[{
    "whatOut", ",", "VbarhatOut", ",", "realinchatOut", ",", "LMhatOut", ",", 
     "LRhatOut", ",", "QhatOut", ",", "PhatOut", ",", "pricehatOut", ",", 
     "\[Lambda]hatOut", ",", "\[Pi]nihatOut", ",", "c", ",", "distWages", ",",
      "dist\[Lambda]"}], "}"}], "=", 
   RowBox[{"comm", "-", "1"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"varnames", "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", "\"\<WHat\>\"", "}"}], ",", 
     RowBox[{"{", "\"\<VbarHat\>\"", "}"}], ",", 
     RowBox[{"{", "\"\<RealIncHat\>\"", "}"}], ",", 
     RowBox[{"{", "\"\<LMhat\>\"", "}"}], ",", 
     RowBox[{"{", "\"\<LRhat\>\"", "}"}], ",", 
     RowBox[{"{", "\"\<QHat\>\"", "}"}], ",", 
     RowBox[{"{", "\"\<PHat\>\"", "}"}], ",", 
     RowBox[{"{", "\"\<PriceHat\>\"", "}"}], ",", 
     RowBox[{"{", "\"\<OwnCommutingHat\>\"", "}"}], ",", 
     RowBox[{"{", "\"\<OwnTradeHat\>\"", "}"}], ",", 
     RowBox[{"{", "\"\<ownTrade\>\"", "}"}]}], "}"}]}], 
  ";"}], "\[IndentingNewLine]"}], "Input",
 CellChangeTimes->{
  3.632849387342736*^9, {3.632851592218201*^9, 3.6328516293859177`*^9}, {
   3.6328517089808764`*^9, 3.6328517546464424`*^9}, {3.633027178552641*^9, 
   3.6330271939531813`*^9}, {3.634601835730294*^9, 3.6346018377583065`*^9}, 
   3.6413211861368585`*^9, {3.6413215392271643`*^9, 3.6413215400262437`*^9}, 
   3.6420589789063873`*^9, {3.6542621814453487`*^9, 3.6542621826453505`*^9}, {
   3.6817291426792483`*^9, 3.6817291431932497`*^9}, {3.734532830116362*^9, 
   3.7345328303163624`*^9}},
 CellLabel->"In[80]:=",ExpressionUUID->"35c78f05-4754-42d2-83eb-3ed874a04fc4"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ownCommHat", "=", 
   RowBox[{"Diagonal", "[", "\[Lambda]hatOut", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ownTradeHat", "=", 
   RowBox[{"Diagonal", "[", "\[Pi]nihatOut", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"out", "=", 
   RowBox[{"Join", "[", 
    RowBox[{"varnames", ",", 
     RowBox[{"{", 
      RowBox[{
      "whatOut", ",", "VbarhatOut", ",", "realinchatOut", ",", "LMhatOut", 
       ",", "LRhatOut", ",", "QhatOut", ",", "PhatOut", ",", "pricehatOut", 
       ",", "ownCommHat", ",", "ownTradeHat", ",", 
       RowBox[{"Diagonal", "[", "\[Pi]niOnlyTrading", "]"}]}], "}"}], ",", 
     "2"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"out", "=", 
   RowBox[{"Transpose", "[", "out", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"out", "=", 
   RowBox[{"Join", "[", 
    RowBox[{"countyNames", ",", "out", ",", "2"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Export", "[", 
   RowBox[{"\"\<data\\\\CZ_decreaseMedian.csv\>\"", ",", "out"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"wel", "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{
      FractionBox[
       RowBox[{
        RowBox[{"whatOut", "[", 
         RowBox[{"[", "i", "]"}], "]"}], "+", "1"}], 
       RowBox[{
        RowBox[{"khat", "[", 
         RowBox[{"[", 
          RowBox[{"i", ",", "i"}], "]"}], "]"}], " ", 
        SuperscriptBox[
         RowBox[{"(", 
          RowBox[{
           RowBox[{"\[Lambda]hatOut", "[", 
            RowBox[{"[", 
             RowBox[{"i", ",", "i"}], "]"}], "]"}], "+", "1"}], ")"}], 
         RowBox[{"1", "/", "\[Epsilon]"}]], " ", 
        SuperscriptBox[
         RowBox[{"(", 
          RowBox[{
           RowBox[{"PhatOut", "[", 
            RowBox[{"[", "i", "]"}], "]"}], "+", "1"}], ")"}], "\[Alpha]"], 
        SuperscriptBox[
         RowBox[{"(", 
          RowBox[{
           RowBox[{"QhatOut", "[", 
            RowBox[{"[", "i", "]"}], "]"}], "+", "1"}], ")"}], 
         RowBox[{"1", "-", "\[Alpha]"}]]}]], " ", 
      SuperscriptBox[
       RowBox[{"bhat", "[", 
        RowBox[{"[", 
         RowBox[{"i", ",", "i"}], "]"}], "]"}], 
       RowBox[{"1", "/", "\[Epsilon]"}]]}], ",", 
     RowBox[{"{", 
      RowBox[{"i", ",", "1", ",", "ncounties"}], "}"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{"{", 
  RowBox[{
   RowBox[{"Min", "[", "wel", "]"}], ",", 
   RowBox[{"Max", "[", "wel", "]"}]}], "}"}], "\[IndentingNewLine]"}], "Input",
 CellChangeTimes->{{3.6276680003228188`*^9, 3.627668105093294*^9}, {
   3.6276682931825323`*^9, 3.627668326687561*^9}, {3.6276683927118053`*^9, 
   3.6276684542882175`*^9}, {3.627668879420566*^9, 3.6276689276203856`*^9}, {
   3.627670106553771*^9, 3.627670198444375*^9}, {3.627670231443434*^9, 
   3.627670242849107*^9}, {3.6276702916686306`*^9, 3.6276703398173504`*^9}, {
   3.627670922131649*^9, 3.627670922615252*^9}, {3.6276736923830986`*^9, 
   3.6276736983386946`*^9}, {3.6328476865586743`*^9, 3.632847756608679*^9}, {
   3.632847813185336*^9, 3.6328478330743246`*^9}, {3.632847878658882*^9, 
   3.6328479112201385`*^9}, {3.6329405892312536`*^9, 3.632940591906521*^9}, {
   3.632940639553285*^9, 3.632940641083438*^9}, {3.632947134790744*^9, 
   3.6329471388161464`*^9}, {3.633025196624468*^9, 3.6330251982066264`*^9}, {
   3.633026072441041*^9, 3.6330260726570625`*^9}, {3.633028527086481*^9, 
   3.633028527343507*^9}, {3.6346020626752415`*^9, 3.6346020975087247`*^9}, {
   3.64132086481973*^9, 3.6413208650337515`*^9}, 3.641320910239271*^9, {
   3.6413214593851805`*^9, 3.6413214888241243`*^9}, {3.6415567121239643`*^9, 
   3.6415567124899645`*^9}, {3.6419251326716385`*^9, 
   3.6419251360789795`*^9}, {3.641925245557926*^9, 3.641925249346305*^9}, {
   3.641944956384615*^9, 3.641944959083432*^9}, {3.641945951846801*^9, 
   3.6419459607574577`*^9}, {3.6419903910217905`*^9, 3.6419903922029085`*^9}, 
   3.6526995241011477`*^9, {3.6526995581612215`*^9, 3.6526995584982233`*^9}, {
   3.65312397241711*^9, 3.6531239902051363`*^9}, {3.653212396134348*^9, 
   3.65321239791435*^9}, {3.654256209526021*^9, 3.6542562098160214`*^9}, {
   3.681729096464632*^9, 3.681729123043208*^9}, 3.6857296840816307`*^9, {
   3.734532837508375*^9, 3.734532839409378*^9}, 3.734534204002451*^9},
 CellLabel->"In[82]:=",ExpressionUUID->"46fff77e-eb2f-43a6-ad00-e4bc33e3fd8c"]
}, Closed]]
}, Closed]]
}, Closed]]
}, Open  ]]
},
CellGrouping->Automatic,
WindowSize->{1920, 998},
WindowMargins->{{-8, Automatic}, {Automatic, -8}},
PrintingCopies->1,
PrintingPageRange->{32000, 32000},
PrintingOptions->{"Magnification"->1.,
"PaperOrientation"->"Portrait",
"PaperSize"->{612., 791.9999999999999}},
FrontEndVersion->"11.3 for Microsoft Windows (64-bit) (March 6, 2018)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[558, 20, 170, 3, 28, "Input",ExpressionUUID->"0ff1df98-17ce-4456-a2eb-4a7d3c9ac082"],
Cell[CellGroupData[{
Cell[753, 27, 406, 6, 96, "Title",ExpressionUUID->"a6a4a3d8-695b-448b-9e0f-8eb7d2fb783a"],
Cell[1162, 35, 247, 5, 53, "Subtitle",ExpressionUUID->"9a9c81ac-84e8-49a4-b6d4-dca1a8295c2f"],
Cell[1412, 42, 221, 4, 35, "Text",ExpressionUUID->"7c25d4a1-497b-4842-b1f3-170f6ee203cb"],
Cell[CellGroupData[{
Cell[1658, 50, 430, 8, 24, "ItemParagraph",ExpressionUUID->"133b1d2e-1ecc-4649-af79-acdd54cec1cd"],
Cell[2091, 60, 367, 7, 24, "ItemParagraph",ExpressionUUID->"7ce4baa3-11a2-4a71-9afb-d41512c541cb"],
Cell[2461, 69, 367, 7, 24, "ItemParagraph",ExpressionUUID->"8f5eb156-204c-4e51-b531-73da46e0edb5"],
Cell[2831, 78, 393, 7, 24, "ItemParagraph",ExpressionUUID->"ee56e337-2dff-4dc2-8a81-7ef0fae00ed5"],
Cell[3227, 87, 394, 7, 24, "ItemParagraph",ExpressionUUID->"721fac1d-ffd8-478c-8f0e-22e10f18c530"]
}, Open  ]],
Cell[CellGroupData[{
Cell[3658, 99, 167, 3, 67, "Chapter",ExpressionUUID->"24810bc2-7e2b-4658-b33f-a1a69c536f30"],
Cell[CellGroupData[{
Cell[3850, 106, 155, 3, 53, "Subsection",ExpressionUUID->"70f29713-897c-4bca-b86a-15f62757f9f1"],
Cell[4008, 111, 281, 6, 34, "Text",ExpressionUUID->"c6255168-3f52-40e8-b44c-c103c5c9250a"],
Cell[4292, 119, 694, 12, 48, "Input",ExpressionUUID->"7a385411-4b61-462d-8105-37f07536a2f1"]
}, Closed]],
Cell[CellGroupData[{
Cell[5023, 136, 315, 5, 37, "Subsection",ExpressionUUID->"cedd2d20-4962-471b-8c44-a4d623cd0ad8"],
Cell[5341, 143, 277, 6, 34, "Text",ExpressionUUID->"b9c099f3-afac-4c79-9e15-ba4bb89fabb9"],
Cell[5621, 151, 9810, 207, 525, "Input",ExpressionUUID->"c9fbaa59-ba95-4802-8467-c5510e9927b5"]
}, Closed]],
Cell[CellGroupData[{
Cell[15468, 363, 158, 3, 37, "Subsection",ExpressionUUID->"695d4f84-2f5a-4e43-927f-c1ff3277ca7e"],
Cell[CellGroupData[{
Cell[15651, 370, 2572, 52, 143, "Input",ExpressionUUID->"e0f5dc00-4131-420c-a21f-8e09ddeefc78"],
Cell[18226, 424, 167, 2, 32, "Output",ExpressionUUID->"2b3caa2a-b3fd-49a5-961b-7b1bf5e06604"]
}, Closed]]
}, Closed]],
Cell[CellGroupData[{
Cell[18442, 432, 271, 4, 37, "Subsection",ExpressionUUID->"7868d4f8-96e9-422b-b9aa-7048bdee3fe2"],
Cell[18716, 438, 493, 9, 56, "Text",ExpressionUUID->"1a527d63-3448-4039-87a0-81310d866c5b"],
Cell[19212, 449, 298, 6, 56, "Text",ExpressionUUID->"7e20a53c-e2f3-4b10-852e-b032283cf2f3"],
Cell[19513, 457, 1682, 40, 86, "Input",ExpressionUUID->"8f404a75-6aa5-4a94-87c6-d03c63beb496"],
Cell[21198, 499, 252, 4, 34, "Text",ExpressionUUID->"51ceffeb-e4e7-4e18-b028-92b5ec96fc9a"],
Cell[21453, 505, 267, 5, 28, "Input",ExpressionUUID->"03ec0c26-be9b-4fe7-b547-108ec29cda6f"]
}, Closed]]
}, Closed]],
Cell[CellGroupData[{
Cell[21769, 516, 181, 3, 56, "Chapter",ExpressionUUID->"5db54d4c-dfcd-4e71-9ce5-9d4d60c7891a"],
Cell[CellGroupData[{
Cell[21975, 523, 170, 3, 64, "Subchapter",ExpressionUUID->"aa5f7054-d3d2-4231-a4e0-e28a31bcc494"],
Cell[22148, 528, 390, 7, 56, "Text",ExpressionUUID->"7351d689-447d-452b-b811-c2dd2ae9361b"],
Cell[22541, 537, 2469, 54, 181, "Input",ExpressionUUID->"d6eddaf4-37ee-4f20-864d-8d5968332cb2"],
Cell[25013, 593, 1156, 19, 122, "Text",ExpressionUUID->"75a9bef1-f92d-4f80-8761-ca6501421c21"],
Cell[26172, 614, 9518, 212, 914, "Input",ExpressionUUID->"a26ba2f3-d1d4-4feb-8909-fd2982898e02"]
}, Closed]],
Cell[CellGroupData[{
Cell[35727, 831, 157, 3, 64, "Subchapter",ExpressionUUID->"d6017916-8671-4779-a066-809cdd3e3d48"],
Cell[35887, 836, 595, 10, 100, "Text",ExpressionUUID->"4f17a335-fedf-4f0b-aa2e-0980db569b11"],
Cell[36485, 848, 3579, 82, 313, "Input",ExpressionUUID->"a538e1d1-1578-4fb4-8cba-c1e53f66e8d5"]
}, Closed]],
Cell[CellGroupData[{
Cell[40101, 935, 372, 6, 64, "Subchapter",ExpressionUUID->"a94b2b28-96d8-4b5a-b49f-e83b1333db81"],
Cell[CellGroupData[{
Cell[40498, 945, 244, 4, 67, "Section",ExpressionUUID->"80869ab6-d2ad-452e-951a-aaf3e4c23dd2"],
Cell[CellGroupData[{
Cell[40767, 953, 314, 5, 44, "Subsubsection",ExpressionUUID->"5a2a130a-9d05-4c00-8968-b5bfeafdf82a"],
Cell[41084, 960, 376, 8, 56, "Text",ExpressionUUID->"c807d43c-0e40-4d26-8f97-fc04db24a702"],
Cell[41463, 970, 16214, 328, 1547, "Input",ExpressionUUID->"3345bcb8-88bf-4a63-9d8d-2f861913750f"]
}, Closed]],
Cell[CellGroupData[{
Cell[57714, 1303, 405, 7, 44, "Subsubsection",ExpressionUUID->"a03d94c5-c6e1-402b-9a96-9235a444219a"],
Cell[58122, 1312, 737, 12, 78, "Text",ExpressionUUID->"894439f3-c31b-424b-a139-3b7d35ae4830"],
Cell[58862, 1326, 15697, 345, 2028, "Input",ExpressionUUID->"5ac0c923-1d37-47b3-8c66-029b5f6c66b6"]
}, Closed]]
}, Closed]],
Cell[CellGroupData[{
Cell[74608, 1677, 226, 4, 67, "Section",ExpressionUUID->"477459ed-1ea0-409c-ba09-f9fee7276c0c"],
Cell[CellGroupData[{
Cell[74859, 1685, 338, 5, 44, "Subsubsection",ExpressionUUID->"57da4884-ceef-4c79-a470-3dd56452be56"],
Cell[75200, 1692, 11571, 250, 1452, "Input",ExpressionUUID->"037acceb-3c8f-4bb2-ada9-089124e60a3b"]
}, Closed]],
Cell[CellGroupData[{
Cell[86808, 1947, 445, 6, 44, "Subsubsection",ExpressionUUID->"26c68960-3248-484a-ba3d-0677366ad4d3"],
Cell[87256, 1955, 14185, 320, 2009, "Input",ExpressionUUID->"5b646cda-2598-44ba-b4d3-3ddb29b70c4d"]
}, Closed]]
}, Closed]]
}, Closed]],
Cell[CellGroupData[{
Cell[101502, 2282, 163, 3, 64, "Subchapter",ExpressionUUID->"a1d9e06a-5579-45e7-9c39-0a1afd7ac443"],
Cell[CellGroupData[{
Cell[101690, 2289, 234, 4, 67, "Section",ExpressionUUID->"bf110bf6-25d7-4f6a-a77e-6c9e285eb123"],
Cell[101927, 2295, 543, 11, 78, "Text",ExpressionUUID->"3b282304-bdaf-4404-b9bb-3e464137669b"],
Cell[102473, 2308, 6174, 139, 845, "Input",ExpressionUUID->"09ccdce0-ff2c-4ba6-a724-57a65fcf79d4"]
}, Closed]]
}, Closed]]
}, Closed]],
Cell[CellGroupData[{
Cell[108708, 2454, 313, 5, 56, "Chapter",ExpressionUUID->"a5007de0-8e78-4783-af18-5889b335bdf9"],
Cell[CellGroupData[{
Cell[109046, 2463, 321, 5, 64, "Subchapter",ExpressionUUID->"a6c326b2-22cb-4be5-800a-828708e33972"],
Cell[CellGroupData[{
Cell[109392, 2472, 339, 5, 67, "Section",ExpressionUUID->"9575d7c0-79e7-4fb8-a8db-e6a79fea5265"],
Cell[109734, 2479, 341, 7, 56, "Text",ExpressionUUID->"6849d774-802c-4367-b9ef-4a22c942ba03"],
Cell[110078, 2488, 499, 10, 67, "Input",ExpressionUUID->"731e5b26-806a-484b-9c95-dfb2b819c67b"]
}, Closed]],
Cell[CellGroupData[{
Cell[110614, 2503, 345, 5, 53, "Section",ExpressionUUID->"0a9d7f75-a3a7-49c8-832c-af12db265b98"],
Cell[110962, 2510, 181, 3, 34, "Text",ExpressionUUID->"89fa6eaa-faf2-466b-a6d4-7c8a04d35610"],
Cell[111146, 2515, 7556, 107, 28, "Input",ExpressionUUID->"60a0c47d-6c56-4f4a-a0f8-8ac9b5b8a77d"],
Cell[118705, 2624, 185, 3, 34, "Text",ExpressionUUID->"026e7e0a-0e53-4c15-a087-663aaf48d6ae"],
Cell[118893, 2629, 539, 11, 48, "Input",ExpressionUUID->"8fd4cb4f-d560-489d-85a3-8425022c6f41"],
Cell[119435, 2642, 319, 6, 34, "Text",ExpressionUUID->"b9f97ff2-53a3-4a96-a6f7-7a7216685752"],
Cell[CellGroupData[{
Cell[119779, 2652, 832, 21, 90, "Input",ExpressionUUID->"b70a2331-15ef-4720-acb7-30e146963920"],
Cell[120614, 2675, 1079, 17, 32, "Output",ExpressionUUID->"00cc3bd1-aa25-44dc-9544-eefbfbe4ef05"],
Cell[121696, 2694, 1079, 17, 32, "Output",ExpressionUUID->"0d54853b-bd6e-424f-9733-3806684559d7"]
}, Closed]]
}, Closed]]
}, Closed]],
Cell[CellGroupData[{
Cell[122836, 2718, 416, 6, 64, "Subchapter",ExpressionUUID->"6df7cc43-6928-4709-b0b8-5a18850750ae"],
Cell[CellGroupData[{
Cell[123277, 2728, 179, 3, 67, "Section",ExpressionUUID->"960a2dfc-8498-4398-9e49-ec02dd333b2a"],
Cell[123459, 2733, 418, 9, 34, "Text",ExpressionUUID->"b56250d6-278b-47f2-b0a2-f3b3014c2c49"],
Cell[123880, 2744, 274, 7, 47, "Input",ExpressionUUID->"0c8fe2e7-9644-4415-a9f3-e8f441c28e31"],
Cell[124157, 2753, 12010, 251, 860, "Input",ExpressionUUID->"dc08f1b7-682b-4c4e-868f-ae0bcdbfedb6"]
}, Closed]]
}, Closed]]
}, Closed]],
Cell[CellGroupData[{
Cell[136228, 3011, 169, 2, 56, "Chapter",ExpressionUUID->"61c38d70-7709-447b-959c-3274594ca09a"],
Cell[CellGroupData[{
Cell[136422, 3017, 383, 6, 64, "Subchapter",ExpressionUUID->"edc6d5c6-add2-4bb1-9b5c-a1c35b8839eb"],
Cell[136808, 3025, 219, 4, 34, "Text",ExpressionUUID->"e4095427-793d-4c2e-baae-05eb2a756273"],
Cell[137030, 3031, 4430, 87, 162, "Input",ExpressionUUID->"c5cd538c-a451-4aad-a531-08e0fb9b07b6"],
Cell[141463, 3120, 162, 3, 34, "Text",ExpressionUUID->"cf848e20-8052-45ba-93c9-a109d948e671"],
Cell[141628, 3125, 2095, 34, 67, "Input",ExpressionUUID->"1dd083bf-7d4a-44ba-9a04-384ac2d41267"],
Cell[143726, 3161, 176, 3, 34, "Text",ExpressionUUID->"ff305875-d751-471d-bcce-616e65d4d531"],
Cell[143905, 3166, 3372, 71, 238, "Input",ExpressionUUID->"400d1266-3584-42d8-9ca6-6a039e725cfa"],
Cell[147280, 3239, 568, 13, 34, "Text",ExpressionUUID->"1c436503-dbfd-4a56-ad57-e3b08bce9d3a"],
Cell[147851, 3254, 1094, 32, 48, "Input",ExpressionUUID->"5cc87d68-da31-4310-8159-65152a6f0a49"]
}, Closed]],
Cell[CellGroupData[{
Cell[148982, 3291, 587, 8, 48, "Subchapter",ExpressionUUID->"0f790108-3498-46b3-8b30-c3f412729a60"],
Cell[CellGroupData[{
Cell[149594, 3303, 254, 4, 67, "Section",ExpressionUUID->"1e86a760-7859-4add-9ed9-2b645a99f1cc"],
Cell[149851, 3309, 496, 9, 78, "Text",ExpressionUUID->"497a57dc-5e2a-4837-80e1-a023ff2310db"],
Cell[150350, 3320, 3679, 92, 238, "Input",ExpressionUUID->"bf08d7f8-fce8-44a5-90a5-6016b7ee018b"],
Cell[CellGroupData[{
Cell[154054, 3416, 570, 11, 28, "Input",ExpressionUUID->"80a283fe-7002-40f1-9943-728f7bb2aa4e"],
Cell[154627, 3429, 1196, 26, 96, "Output",ExpressionUUID->"51aaa20b-204c-4760-ac96-257f99c77831"]
}, Closed]],
Cell[155838, 3458, 154, 3, 28, "Input",ExpressionUUID->"63303168-3590-441f-8e20-0886ac3033fb"],
Cell[155995, 3463, 723, 14, 48, "Input",ExpressionUUID->"d6b27608-8c69-4cbc-87a8-a04e2b76349e"],
Cell[156721, 3479, 1659, 34, 105, "Input",ExpressionUUID->"35c78f05-4754-42d2-83eb-3ed874a04fc4"],
Cell[158383, 3515, 4421, 99, 251, "Input",ExpressionUUID->"46fff77e-eb2f-43a6-ad00-e4bc33e3fd8c"]
}, Closed]]
}, Closed]]
}, Closed]]
}, Open  ]]
}
]
*)

